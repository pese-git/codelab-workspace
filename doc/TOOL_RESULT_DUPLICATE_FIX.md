# Tool Result Duplicate Response Fix

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è tool execution:
1. **–î—É–±–ª–∏—Ä—É—é—Ç—Å—è –æ—Ç–≤–µ—Ç—ã –æ—Ç –±—ç–∫–µ–Ω–¥–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–∞
2. **Tool result –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î** - –≤ —Ç–∞–±–ª–∏—Ü–µ `messages` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø–∏—Å—å —Å `role='tool'`

## üîç –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

–ò–∑ –ª–æ–≥–æ–≤ agent-runtime –≤–∏–¥–Ω–æ, —á—Ç–æ `tool_result` **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –î–í–ê–ñ–î–´**:

```
14:34:05,373 - –û–±—Ä–∞–±–æ—Ç–∫–∞ tool_result –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 1 chunks
14:34:05,373 - ‚úÖ Tool result committed to DB (call_id=call_Kx502IDULFviil8oWvG4Yoqx)
14:34:05,376 - Processing tool_result for session (call_id=call_Kx502IDULFviil8oWvG4Yoqx) <- –î–£–ë–õ–ò–ö–ê–¢!
14:34:07,534 - –û–±—Ä–∞–±–æ—Ç–∫–∞ tool_result –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 1 chunks
14:34:07,534 - ‚úÖ Tool result committed to DB (call_id=call_Kx502IDULFviil8oWvG4Yoqx)
```

**–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏: 3ms** - —ç—Ç–æ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ HTTP-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç IDE.

## üéØ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1: IDE –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç tool_result –¥–≤–∞–∂–¥—ã

**–ü–æ—Ç–æ–∫ –≤ IDE:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä—è–µ—Ç tool ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `hitl_decision`
2. `HITLDecisionHandler` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ
3. `ApprovalMiddleware._executeApprovedTool()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç tool
4. `ApprovalMiddleware` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `tool_result` –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å—Ç—Ä–æ–∫–∏ 247-253)
5. **–í–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –µ—â–µ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `tool_result`?**

### –ì–∏–ø–æ—Ç–µ–∑–∞ 2: Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç tool_result –¥–≤–∞–∂–¥—ã

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –î–≤–∞ —Ä–∞–∑–Ω—ã—Ö endpoint'–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å
- Middleware –¥—É–±–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
- Gateway –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π commit –ø–æ—Å–ª–µ add_tool_result

**–§–∞–π–ª—ã:**
- [`ProcessToolResultUseCase`](../codelab-ai-service/agent-runtime/app/application/use_cases/process_tool_result_use_case.py)
- [`DIContainer`](../codelab-ai-service/agent-runtime/app/core/di/container.py)
- [`messages_router.py`](../codelab-ai-service/agent-runtime/app/api/v1/routers/messages_router.py)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# ProcessToolResultUseCase
async with self._lock_manager.lock(request.session_id):
    async for chunk in self._tool_result_handler.handle(...):
        yield chunk
    
    # ‚úÖ –Ø–≤–Ω—ã–π commit –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    if self._uow:
        await self._uow.commit(operation="process_tool_result")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Commit –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö)
- ‚ùå Tool result –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

## üîß –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ù–∞–π—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `request_id` –≤ –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Gateway - –Ω–µ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –ª–∏ –æ–Ω –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å IDE - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∏ –æ–Ω `tool_result` –¥–≤–∞–∂–¥—ã

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É tool_result –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ commit
- `add_tool_result` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–Ω–æ –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
- –ü—Ä–æ–±–ª–µ–º–∞ —Å repository/ORM
- –ü—Ä–æ–±–ª–µ–º–∞ —Å session isolation level

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `ConversationManagementService.add_tool_result()`
2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `ConversationManagementService.add_message()`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ `repo.save()`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã (–≤–∫–ª—é—á–∏—Ç—å SQLAlchemy echo)

### 3. –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ backend

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í ProcessToolResultUseCase –∏–ª–∏ ToolResultHandler
# –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —ç—Ç–æ—Ç call_id
processed_calls = set()

if request.call_id in processed_calls:
    logger.warning(f"Tool result {request.call_id} already processed, skipping")
    return
    
processed_calls.add(request.call_id)
```

## üìä –°—Ç–∞—Ç—É—Å

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π commit –ø–æ—Å–ª–µ tool_result
- ‚úÖ Commit –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ª–æ–≥–∞–º–∏)
- ‚ùå Tool result –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (—Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–í–∫–ª—é—á–∏—Ç—å SQL logging** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
2. **–î–æ–±–∞–≤–∏—Ç—å request_id** –≤ –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Gateway** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å IDE** - –æ—Ç–∫—É–¥–∞ –∏–¥–µ—Ç –≤—Ç–æ—Ä–æ–π `tool_result`
5. **–î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é** –Ω–∞ —É—Ä–æ–≤–Ω–µ backend –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

## üìù –ö–æ–º–º–∏—Ç—ã

- `224a1de` - fix: add explicit commit after tool_result to prevent data loss
- `bf41580` - fix: update submodule - add explicit commit after tool_result
