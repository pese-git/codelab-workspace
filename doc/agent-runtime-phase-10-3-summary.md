# ‚úÖ –§–∞–∑–∞ 10.3: Application Layer - –ó–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 6 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í—Ä–µ–º—è:** 1 —á–∞—Å (–ø–ª–∞–Ω: 3.5 —á–∞—Å–∞) - —ç–∫–æ–Ω–æ–º–∏—è 2.5 —á–∞—Å–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

---

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è DDD-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –≤ Application Layer

‚úÖ **–°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_execution_plan_repository()`**
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `PlanId`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ExecutionPlanMapper` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Value Objects
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `PlanId.value` –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö

‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_execution_engine()`**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ExecutionEngineAdapter` –≤–º–µ—Å—Ç–æ legacy `ExecutionEngine`
- –ò–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç `PlanExecutionService` –∏ `ExecutionPlanRepository`
- –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É –≤ Domain Services

‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω `ExecutionCoordinator`**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `Union[ExecutionEngine, ExecutionEngineAdapter]`
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å legacy –∫–æ–¥–æ–º
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —É–¥–∞–ª–µ–Ω–∏—é legacy –≤ –§–∞–∑–µ 10.4

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
sqlalchemy.exc.DBAPIError: invalid input for query argument $1: 
PlanId(value='01JGQXQXQXQXQXQXQXQXQX') (expected str, got PlanId)
```

**–ü—Ä–∏—á–∏–Ω–∞:** Legacy –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–≤–∞–ª `PlanId` –æ–±—ä–µ–∫—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ SQL –∑–∞–ø—Ä–æ—Å

**–†–µ—à–µ–Ω–∏–µ:** –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π `ExecutionPlanRepositoryImpl` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `.value` –∏–∑ `PlanId`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –í –ª–æ–≥–∞—Ö –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –Ω–µ—Ç –æ—à–∏–±–æ–∫ —Å `PlanId`

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ | 2 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | 58 –≤—Å—Ç–∞–≤–æ–∫, 22 —É–¥–∞–ª–µ–Ω–∏—è |
| –í—Ä–µ–º—è (–ø–ª–∞–Ω/—Ñ–∞–∫—Ç) | 3.5—á / 1—á |
| –≠–∫–æ–Ω–æ–º–∏—è | 2.5 —á–∞—Å–∞ (71%) |
| –¢–µ—Å—Ç—ã | –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω |
| Docker | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫ |

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. [`app/core/dependencies.py`](../codelab-ai-service/agent-runtime/app/core/dependencies.py)
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ `get_execution_plan_repository()`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ `get_execution_engine()`

2. [`app/application/coordinators/execution_coordinator.py`](../codelab-ai-service/agent-runtime/app/application/coordinators/execution_coordinator.py)
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `Union[ExecutionEngine, ExecutionEngineAdapter]`

---

## üîó Dependency Injection Flow

```
get_execution_engine()
  ‚Üì
ExecutionEngineAdapter
  ‚îú‚îÄ‚îÄ PlanExecutionService (Depends)
  ‚îî‚îÄ‚îÄ ExecutionPlanRepository (Depends)
        ‚Üì
      ExecutionPlanRepositoryImpl
        ‚îú‚îÄ‚îÄ AsyncSession (Depends)
        ‚îî‚îÄ‚îÄ ExecutionPlanMapper
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** [`agent-runtime-phase-10-3-analysis.md`](agent-runtime-phase-10-3-analysis.md) (500+ —Å—Ç—Ä–æ–∫)
- **–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç:** [`agent-runtime-phase-10-3-completion-report.md`](agent-runtime-phase-10-3-completion-report.md)
- **–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:** [`agent-runtime-phase-10-progress.md`](agent-runtime-phase-10-progress.md)

---

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –§–∞–∑—ã 10

| –ü–æ–¥—Ñ–∞–∑–∞ | –°—Ç–∞—Ç—É—Å | –í—Ä–µ–º—è |
|---------|--------|-------|
| 10.1.1 | ‚úÖ | 1.5—á / 2—á |
| 10.1.2 | ‚úÖ | 1.5—á / 2—á |
| 10.1.3 | ‚úÖ | 1.5—á / 3—á |
| 10.1.4 | ‚úÖ | 2.5—á / 5—á |
| 10.2 | ‚úÖ | 3.5—á / 7—á |
| 10.3 | ‚úÖ | 1—á / 3.5—á |
| 10.4 | ‚è≥ | - / 2.5—á |
| **–ò—Ç–æ–≥–æ** | **55%** | **11.5—á / 21—á** |

**–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è:** 9.5 —á–∞—Å–æ–≤

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

### –§–∞–∑–∞ 10.4: –£–¥–∞–ª–µ–Ω–∏–µ Legacy Code (2-3 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**
1. –£–¥–∞–ª–∏—Ç—å legacy entities (Session, AgentContext, ExecutionPlan)
2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ repositories
3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ services
4. –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
5. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¶–µ–ª—å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ DDD-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

1. ‚úÖ Application Layer –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å DDD-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å `PlanId` –≤ SQL
3. ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ DI Container
4. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å legacy –∫–æ–¥–æ–º
5. ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üéâ –ò—Ç–æ–≥

**Application Layer —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É!**

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç:
- ‚úÖ DDD Entities –≤–º–µ—Å—Ç–æ legacy entities
- ‚úÖ Value Objects –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ Domain Services –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ Adapters –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ñ–∞–∑–µ - —É–¥–∞–ª–µ–Ω–∏—é legacy –∫–æ–¥–∞! üöÄ
