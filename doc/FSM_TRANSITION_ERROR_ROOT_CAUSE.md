# FSM Transition Error: Root Cause Analysis

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞ FSM: `Invalid transition from execution to plan_approved`

## üîç –ê–Ω–∞–ª–∏–∑

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω –∏ –æ–¥–æ–±—Ä–µ–Ω ‚Üí FSM –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `PLAN_EXECUTION`
2. Subtask –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Üí tool —Ç—Ä–µ–±—É–µ—Ç approval (HITL)
3. SSE —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è HITL)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä—è–µ—Ç tool —á–µ—Ä–µ–∑ `hitl_decision`
5. **–ì–¥–µ-—Ç–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å FSM transition —Å —Å–æ–±—ã—Ç–∏–µ–º `PLAN_APPROVED`**
6. –û—à–∏–±–∫–∞: `PLAN_APPROVED` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ `PLAN_REVIEW`, –Ω–µ –∏–∑ `PLAN_EXECUTION`

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–ü—É—Ç–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–∏–ø–∞–º–∏ approval:**

1. **Plan Approval** - –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
   - –°–æ–±—ã—Ç–∏–µ: `FSMEvent.PLAN_APPROVED`
   - –ü–µ—Ä–µ—Ö–æ–¥: `PLAN_REVIEW ‚Üí PLAN_EXECUTION`
   - Endpoint: `POST /agent/message/stream` —Å `type: "plan_decision"`

2. **Tool Approval (HITL)** - –æ–¥–æ–±—Ä–µ–Ω–∏–µ tool –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –°–æ–±—ã—Ç–∏–µ: –ù–ï–¢ FSM —Å–æ–±—ã—Ç–∏—è (—ç—Ç–æ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
   - –°–æ—Å—Ç–æ—è–Ω–∏–µ: –æ—Å—Ç–∞–µ—Ç—Å—è `PLAN_EXECUTION` –∏–ª–∏ `EXECUTION`
   - Endpoint: `POST /agent/message/stream` —Å `type: "hitl_decision"`

### –ì–¥–µ –æ—à–∏–±–∫–∞?

–°—É–¥—è –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é "–æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–∏ SSE stream –ø–æ—Å–ª–µ tool approval", –ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Å–∞–º–æ–º tool approval, –∞ –≤ —Ç–æ–º, —á—Ç–æ **–ø–æ—Å–ª–µ tool approval –≥–¥–µ-—Ç–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π FSM transition**.

## üéØ –í–µ—Ä–æ—è—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏

–ü—Ä–æ–±–ª–µ–º–∞ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ **–ù–ï –≤ FSM**, –∞ –≤ —Ç–æ–º, —á—Ç–æ:

1. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞** –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞–Ω–∞ –Ω–∞ `APPROVED`
2. –ü—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω —á–∏—Ç–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. –ü–ª–∞–Ω –Ω–µ –≤–∏–¥–µ–Ω (—Å—Ç–∞—Ç—É—Å –Ω–µ `APPROVED`)
4. –ö–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞ —Å–¥–µ–ª–∞—Ç—å approval ‚Üí –æ—à–∏–±–∫–∞ FSM

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ —É–∂–µ —Ä–µ—à–µ–Ω–∞ –≤ [`PLAN_TRANSACTION_ISOLATION_FIX.md`](PLAN_TRANSACTION_ISOLATION_FIX.md):

- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `commit=True` –≤ [`plan_repository_impl.py:59`](../codelab-ai-service/agent-runtime/app/infrastructure/persistence/repositories/plan_repository_impl.py:59)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `commit=True` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞ –≤ [`architect_agent.py:243`](../codelab-ai-service/agent-runtime/app/agents/architect_agent.py:243)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `commit=True` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ [`plan_approval_handler.py:166`](../codelab-ai-service/agent-runtime/app/domain/services/plan_approval_handler.py:166)

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞

–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –æ—à–∏–±–æ–∫ –≤ –±—É–¥—É—â–µ–º, –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM –≤ [`plan_approval_handler.py`](../codelab-ai-service/agent-runtime/app/domain/services/plan_approval_handler.py):

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM –ø–µ—Ä–µ–¥ approval
current_state = await self._fsm_orchestrator.get_current_state(session_id)

if current_state != FSMState.PLAN_REVIEW:
    error_msg = (
        f"Cannot approve plan: invalid FSM state. "
        f"Expected PLAN_REVIEW, got {current_state.value}"
    )
    logger.error(error_msg)
    yield StreamChunk(type="error", error=error_msg, is_final=True)
    return
```

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ–ø—ã—Ç–∫—É plan approval –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

## üìù –í—ã–≤–æ–¥

**–û—à–∏–±–∫–∞ "execution -> plan_approved" –ù–ï –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å**, –µ—Å–ª–∏:

1. ‚úÖ –ü–ª–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è —Å `commit=True` (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM –ø–µ—Ä–µ–¥ approval (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)

**–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –∏–∑-–∑–∞:**
- –ü–ª–∞–Ω –Ω–µ –±—ã–ª –≤–∏–¥–µ–Ω –≤ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω)
- –ö–æ–¥ –ø—ã—Ç–∞–ª—Å—è —Å–Ω–æ–≤–∞ —Å–¥–µ–ª–∞—Ç—å approval
- FSM —É–∂–µ –±—ã–ª –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `PLAN_EXECUTION` (–∏–ª–∏ `EXECUTION`)
- –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ `PLAN_APPROVED` –∏–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Üí –æ—à–∏–±–∫–∞

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ü–ª–∞–Ω –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ ‚Üí –≤–∏–¥–µ–Ω –≤–æ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
- –û—à–∏–±–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
