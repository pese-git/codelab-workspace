# ğŸ—ï¸ Agent Runtime â€” Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

**Ğ”Ğ°Ñ‚Ğ°:** 4 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½

---

## ğŸ“‹ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [Architectural Analysis (Before)](#1-architectural-analysis-before)
2. [Target Architecture](#2-target-architecture)
3. [Project Structure](#3-project-structure)
4. [Key Architectural Decisions](#4-key-architectural-decisions)
5. [Refactoring Plan](#5-refactoring-plan)
6. [Compatibility Guarantees](#6-compatibility-guarantees)
7. [Final Notes](#7-final-notes)

---

## 1. Architectural Analysis (Before)

### 1.1 Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Layer (FastAPI)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ sessions_    â”‚  â”‚ messages_    â”‚  â”‚ agents_      â”‚      â”‚
â”‚  â”‚ router       â”‚  â”‚ router       â”‚  â”‚ router       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer (CQRS Handlers)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Command      â”‚  â”‚ Query        â”‚  â”‚ Coordinators â”‚      â”‚
â”‚  â”‚ Handlers     â”‚  â”‚ Handlers     â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Services (Orchestration)                             â”‚   â”‚
â”‚  â”‚  â€¢ MessageOrchestrationService (Ğ¤Ğ°ÑĞ°Ğ´, 432 ÑÑ‚Ñ€Ğ¾ĞºĞ¸)  â”‚   â”‚
â”‚  â”‚  â€¢ SessionManagementService (608 ÑÑ‚Ñ€Ğ¾Ğº)             â”‚   â”‚
â”‚  â”‚  â€¢ AgentOrchestrationService (236 ÑÑ‚Ñ€Ğ¾Ğº)            â”‚   â”‚
â”‚  â”‚  â€¢ MessageProcessor, AgentSwitcher, etc.            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Entities                                             â”‚   â”‚
â”‚  â”‚  â€¢ Session (501 ÑÑ‚Ñ€Ğ¾ĞºĞ°) â€” God Object                â”‚   â”‚
â”‚  â”‚  â€¢ AgentContext, Message, Plan, Approval            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Repositories (Interfaces)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Infrastructure Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Persistence  â”‚  â”‚ LLM Client   â”‚  â”‚ Event Bus    â”‚      â”‚
â”‚  â”‚ (SQLAlchemy) â”‚  â”‚ (HTTP)       â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

#### **API Layer**
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Ğ§ĞµÑ‚ĞºĞ¾Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ¾Ğ² Ğ¿Ğ¾ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°Ğ¼
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Pydantic ÑÑ…ĞµĞ¼ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
- âš ï¸ **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€Ğ¾Ğ² (Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)

#### **Application Layer**
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** CQRS Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ (Commands/Queries)
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Handlers Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹
- âš ï¸ **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** StreamLLMResponseHandler Ğ½Ğ°Ñ€ÑƒÑˆĞ°ĞµÑ‚ SRP (275+ ÑÑ‚Ñ€Ğ¾Ğº)

#### **Domain Layer**
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Ğ‘Ğ¾Ğ³Ğ°Ñ‚Ñ‹Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Ğ”Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
- âš ï¸ **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Session â€” God Object (501 ÑÑ‚Ñ€Ğ¾ĞºĞ°, 20+ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²)
- âš ï¸ **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹ Ğ² ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ…

#### **Infrastructure Layer**
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¾Ñ‚ Domain
- âœ… **Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾:** ĞĞ´Ğ°Ğ¿Ñ‚ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼
- âš ï¸ **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** LLMClient Ñ‚ĞµÑĞ½Ğ¾ ÑĞ²ÑĞ·Ğ°Ğ½ Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹

### 1.3 ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ°Ñ…Ğ¸

#### ğŸ”´ **ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹**

1. **God Object: Session Entity**
   ```python
   class Session(Entity):
       # 501 ÑÑ‚Ñ€Ğ¾ĞºĞ°, 20+ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²
       # Ğ¡Ğ¼ĞµÑˆĞ¸Ğ²Ğ°ĞµÑ‚:
       # - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸
       # - Snapshot/restore Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
       # - Tool message Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºÑƒ
       # - Agent switch ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
   ```
   **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ SRP, ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ

2. **ĞĞ½ĞµĞ¼Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ² Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ¼ĞµÑÑ‚Ğ°Ñ…**
   ```python
   class Message(Entity):
       # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ, Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ
       # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ½ĞµÑĞµĞ½Ğ° Ğ² ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
   ```

3. **Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸**
   - Snapshot/restore Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ·Ğ¼Ğ°Ğ·Ğ°Ğ½Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Session Ğ¸ SessionManagementService
   - Tool message Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°Ñ…

4. **ĞĞµÑĞ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸**
   ```python
   # dependencies.py â€” 814 ÑÑ‚Ñ€Ğ¾Ğº
   # Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ°Ñ ÑĞµÑ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ñ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ğ¼Ğ¸
   ```

5. **ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Dependency Rule**
   ```python
   # Domain Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Application Ñ‡ĞµÑ€ĞµĞ· IStreamHandler
   # ĞĞ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ StreamLLMResponseHandler Ğ² Application
   # Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Domain ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² â€” Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
   ```

#### ğŸŸ¡ **Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹**

6. **Ğ¤Ğ°ÑĞ°Ğ´ ĞºĞ°Ğº ĞºĞ¾ÑÑ‚Ñ‹Ğ»ÑŒ**
   ```python
   class MessageOrchestrationService:
       # 432 ÑÑ‚Ñ€Ğ¾ĞºĞ¸
       # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ´ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹
       # ĞĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ
   ```

7. **Ğ˜Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ñ**
   - ĞĞ´Ğ°Ğ¿Ñ‚ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (SessionManagerAdapter)
   - ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ ĞºĞ¾Ğ´Ğµ

8. **Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ concerns Ğ² dependencies.py**
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
   - ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
   - Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
   - 814 ÑÑ‚Ñ€Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ

9. **ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ÑĞ²Ğ½Ñ‹Ñ… Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ† ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²**
   - Session management
   - Agent orchestration
   - Plan execution
   - Approval management
   - Ğ’ÑĞµ ÑĞ¼ĞµÑˆĞ°Ğ½Ğ¾ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Domain ÑĞ»Ğ¾Ğµ

#### ğŸŸ¢ **ĞœĞ¸Ğ½Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹**

10. **ĞĞµĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**
    - `SessionManagementService` vs `AgentOrchestrationService`
    - `MessageProcessor` vs `ToolResultHandler`

11. **Ğ˜Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**
    - Ğ›Ğ¾Ğ³Ğ¸ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ
    - Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸

12. **ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ÑĞ²Ğ½Ñ‹Ñ… Value Objects**
    - SessionId, AgentType Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²Ñ‹
    - ĞĞµÑ‚ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸

### 1.4 Ğ¢Ğ¾Ñ‡ĞºĞ¸ ÑĞ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸

```mermaid
graph TB
    subgraph "Tight Coupling Points"
        Session[Session Entity<br/>501 lines]
        SessionService[SessionManagementService<br/>608 lines]
        MessageOrch[MessageOrchestrationService<br/>432 lines]
        Dependencies[dependencies.py<br/>814 lines]
        
        Session -.->|20+ methods| SessionService
        SessionService -.->|complex logic| Session
        MessageOrch -.->|delegates to| SessionService
        Dependencies -.->|creates all| Session
        Dependencies -.->|creates all| SessionService
        Dependencies -.->|creates all| MessageOrch
    end
    
    style Session fill:#ff6b6b
    style SessionService fill:#ff6b6b
    style MessageOrch fill:#ffd43b
    style Dependencies fill:#ff6b6b
```

### 1.5 ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ¸ | ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ | Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ | Ğ¦Ğ¸ĞºĞ»Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ |
|-----------|--------|--------|-------------|---------------------------|
| Session | 501 | 20+ | 5 | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ |
| SessionManagementService | 608 | 15+ | 3 | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ |
| MessageOrchestrationService | 432 | 8 | 10+ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ |
| dependencies.py | 814 | 40+ | 50+ | ĞÑ‡ĞµĞ½ÑŒ Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ |
| StreamLLMResponseHandler | 275+ | 10+ | 8 | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ |

---

## 2. Target Architecture

### 2.1 ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

1. **Clean Architecture** â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾Ğµ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ Dependency Rule
2. **Domain-Driven Design** â€” ÑĞ²Ğ½Ñ‹Ğµ bounded contexts
3. **SOLID** â€” ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ğ´Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
4. **Ports & Adapters** â€” Ğ¸Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ğ¾Ñ‚ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼
5. **KISS** â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµ Ğ²ÑĞµĞ³Ğ¾

### 2.2 Bounded Contexts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Runtime System                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Session Context    â”‚  â”‚ Agent Context      â”‚            â”‚
â”‚  â”‚ â€¢ Conversation     â”‚  â”‚ â€¢ Routing          â”‚            â”‚
â”‚  â”‚ â€¢ Messages         â”‚  â”‚ â€¢ Switching        â”‚            â”‚
â”‚  â”‚ â€¢ History          â”‚  â”‚ â€¢ Capabilities     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Execution Context  â”‚  â”‚ Approval Context   â”‚            â”‚
â”‚  â”‚ â€¢ Plans            â”‚  â”‚ â€¢ HITL             â”‚            â”‚
â”‚  â”‚ â€¢ Subtasks         â”‚  â”‚ â€¢ Policies         â”‚            â”‚
â”‚  â”‚ â€¢ Dependencies     â”‚  â”‚ â€¢ Decisions        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ LLM Context        â”‚  â”‚ Event Context      â”‚            â”‚
â”‚  â”‚ â€¢ Streaming        â”‚  â”‚ â€¢ Publishing       â”‚            â”‚
â”‚  â”‚ â€¢ Tool calls       â”‚  â”‚ â€¢ Subscribing      â”‚            â”‚
â”‚  â”‚ â€¢ Responses        â”‚  â”‚ â€¢ Auditing         â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Ğ¡Ğ»Ğ¾Ğ¸ÑÑ‚Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° (ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â€¢ REST API (FastAPI)                                       â”‚
â”‚  â€¢ WebSocket handlers                                       â”‚
â”‚  â€¢ Request/Response DTOs                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Use Cases    â”‚  â”‚ Commands     â”‚  â”‚ Queries      â”‚      â”‚
â”‚  â”‚ (Scenarios)  â”‚  â”‚ (Write)      â”‚  â”‚ (Read)       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Application Services (Orchestration)                 â”‚   â”‚
â”‚  â”‚  â€¢ ProcessMessageUseCase                            â”‚   â”‚
â”‚  â”‚  â€¢ SwitchAgentUseCase                               â”‚   â”‚
â”‚  â”‚  â€¢ ExecutePlanUseCase                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Bounded Contexts (Modules)                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Session    â”‚  â”‚ Agent      â”‚  â”‚ Execution  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Module     â”‚  â”‚ Module     â”‚  â”‚ Module     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Domain Services (Business Logic)                     â”‚   â”‚
â”‚  â”‚  â€¢ ConversationService                               â”‚   â”‚
â”‚  â”‚  â€¢ AgentRoutingService                               â”‚   â”‚
â”‚  â”‚  â€¢ PlanExecutionService                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Entities & Value Objects                             â”‚   â”‚
â”‚  â”‚  â€¢ Conversation (Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Session)                     â”‚   â”‚
â”‚  â”‚  â€¢ AgentContext                                      â”‚   â”‚
â”‚  â”‚  â€¢ ExecutionPlan                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Domain Events                                        â”‚   â”‚
â”‚  â”‚  â€¢ ConversationStarted                               â”‚   â”‚
â”‚  â”‚  â€¢ AgentSwitched                                     â”‚   â”‚
â”‚  â”‚  â€¢ PlanExecuted                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Repository Interfaces (Ports)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Infrastructure Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Persistence  â”‚  â”‚ External     â”‚  â”‚ Messaging    â”‚      â”‚
â”‚  â”‚ (Adapters)   â”‚  â”‚ Services     â”‚  â”‚ (Event Bus)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

#### **1. Ğ Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ğµ Session Ğ½Ğ° ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹**

```python
# âŒ Ğ‘Ğ«Ğ›Ğ: God Object
class Session(Entity):
    # 501 ÑÑ‚Ñ€Ğ¾ĞºĞ°, 20+ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²
    pass

# âœ… Ğ¡Ğ¢ĞĞ›Ğ: Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ÑŒ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ
class Conversation(Entity):
    """Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ¼"""
    id: ConversationId
    messages: MessageCollection
    metadata: ConversationMetadata
    
    def add_message(self, message: Message) -> None:
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹"""
        self.messages.add(message)
        self._update_activity()

# Value Object Ğ´Ğ»Ñ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
class MessageCollection:
    """Ğ˜Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸"""
    _messages: List[Message]
    
    def add(self, message: Message) -> None: ...
    def get_recent(self, limit: int) -> List[Message]: ...
    def filter_by_role(self, role: str) -> List[Message]: ...
    def to_llm_format(self) -> List[Dict]: ...

# Domain Service Ğ´Ğ»Ñ snapshot Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸
class ConversationSnapshotService:
    """Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ snapshot'Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°"""
    def create_snapshot(self, conversation: Conversation) -> Snapshot: ...
    def restore_from_snapshot(self, conversation: Conversation, snapshot: Snapshot) -> None: ...

# Domain Service Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ tool messages
class ToolMessageCleanupService:
    """ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° tool-related messages"""
    def clear_tool_messages(self, conversation: Conversation) -> int: ...
    def prepare_agent_switch_context(self, conversation: Conversation, from_agent: str, to_agent: str) -> CleanupInfo: ...
```

#### **2. Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ MessageOrchestrationService**

```python
# âŒ Ğ‘Ğ«Ğ›Ğ: Ğ¤Ğ°ÑĞ°Ğ´ Ğ±ĞµĞ· Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
class MessageOrchestrationService:
    # 432 ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ´ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    async def process_message(self, ...): ...
    async def switch_agent(self, ...): ...
    async def process_tool_result(self, ...): ...
    # ... ĞµÑ‰Ğµ 5 Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²

# âœ… Ğ¡Ğ¢ĞĞ›Ğ: Use Cases Ğ² Application Layer

class ProcessMessageUseCase:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ"""
    def __init__(
        self,
        conversation_service: ConversationService,
        agent_routing_service: AgentRoutingService,
        llm_service: LLMService
    ): ...
    
    async def execute(self, request: ProcessMessageRequest) -> AsyncGenerator[StreamChunk, None]:
        # ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ· Ğ´ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        conversation = await self.conversation_service.get_or_create(request.session_id)
        agent = await self.agent_routing_service.route(conversation, request.message)
        async for chunk in self.llm_service.stream_response(agent, conversation):
            yield chunk

class SwitchAgentUseCase:
    """ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°"""
    # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾

class ProcessToolResultUseCase:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°"""
    # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾
```

#### **3. Ğ ĞµĞ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ dependencies.py**

```python
# âŒ Ğ‘Ğ«Ğ›Ğ: 814 ÑÑ‚Ñ€Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ
# dependencies.py

# âœ… Ğ¡Ğ¢ĞĞ›Ğ: ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

# app/core/di/session_module.py
class SessionModule:
    """DI Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Session Context"""
    @staticmethod
    def provide_conversation_repository(db: AsyncSession) -> ConversationRepository:
        return ConversationRepositoryImpl(db)
    
    @staticmethod
    def provide_conversation_service(repo: ConversationRepository) -> ConversationService:
        return ConversationService(repo)

# app/core/di/agent_module.py
class AgentModule:
    """DI Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Agent Context"""
    # ...

# app/core/di/container.py
class DIContainer:
    """Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹"""
    def __init__(self):
        self.session_module = SessionModule()
        self.agent_module = AgentModule()
        # ...
```

#### **4. Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Value Objects**

```python
# âœ… ĞĞĞ’ĞĞ•: Value Objects Ğ´Ğ»Ñ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸

class ConversationId(ValueObject):
    """ID ÑĞµÑÑĞ¸Ğ¸ Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹"""
    value: str
    
    def __init__(self, value: str):
        if not value or len(value) > 255:
            raise ValueError("Invalid conversation ID")
        self.value = value
    
    def __eq__(self, other): ...
    def __hash__(self): ...

class AgentType(ValueObject):
    """Ğ¢Ğ¸Ğ¿ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹"""
    value: str
    
    @staticmethod
    def orchestrator() -> 'AgentType':
        return AgentType("orchestrator")
    
    @staticmethod
    def coder() -> 'AgentType':
        return AgentType("coder")
    
    # ...

class MessageContent(ValueObject):
    """Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹"""
    text: str
    max_length: int = 100000
    
    def __init__(self, text: str):
        if len(text) > self.max_length:
            raise ValueError(f"Message too long: {len(text)} > {self.max_length}")
        self.text = text
```

#### **5. Ğ¯Ğ²Ğ½Ñ‹Ğµ Bounded Contexts**

```
app/domain/
â”œâ”€â”€ session_context/          # Session Bounded Context
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ conversation.py
â”‚   â”‚   â””â”€â”€ message.py
â”‚   â”œâ”€â”€ value_objects/
â”‚   â”‚   â”œâ”€â”€ conversation_id.py
â”‚   â”‚   â””â”€â”€ message_content.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ conversation_service.py
â”‚   â”‚   â””â”€â”€ snapshot_service.py
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ conversation_repository.py
â”‚   â””â”€â”€ events/
â”‚       â””â”€â”€ conversation_events.py
â”‚
â”œâ”€â”€ agent_context/            # Agent Bounded Context
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ agent_context.py
â”‚   â”œâ”€â”€ value_objects/
â”‚   â”‚   â””â”€â”€ agent_type.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ agent_routing_service.py
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ agent_context_repository.py
â”‚
â”œâ”€â”€ execution_context/        # Execution Bounded Context
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ execution_plan.py
â”‚   â”‚   â””â”€â”€ subtask.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ plan_execution_service.py
â”‚   â”‚   â””â”€â”€ dependency_resolver.py
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ plan_repository.py
â”‚
â””â”€â”€ shared/                   # Shared Kernel
    â”œâ”€â”€ base_entity.py
    â”œâ”€â”€ value_object.py
    â””â”€â”€ domain_event.py
```

---

## 3. Project Structure

### 3.1 Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
agent-runtime/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                          # FastAPI entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                             # Presentation Layer
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ routers/
â”‚   â”‚       â”‚   â”œâ”€â”€ conversations_router.py  # Renamed from sessions
â”‚   â”‚       â”‚   â”œâ”€â”€ agents_router.py
â”‚   â”‚       â”‚   â”œâ”€â”€ messages_router.py
â”‚   â”‚       â”‚   â””â”€â”€ plans_router.py
â”‚   â”‚       â””â”€â”€ schemas/
â”‚   â”‚           â”œâ”€â”€ conversation_schemas.py
â”‚   â”‚           â”œâ”€â”€ agent_schemas.py
â”‚   â”‚           â””â”€â”€ message_schemas.py
â”‚   â”‚
â”‚   â”œâ”€â”€ application/                     # Application Layer
â”‚   â”‚   â”œâ”€â”€ use_cases/                   # Use Cases (NEW)
â”‚   â”‚   â”‚   â”œâ”€â”€ process_message_use_case.py
â”‚   â”‚   â”‚   â”œâ”€â”€ switch_agent_use_case.py
â”‚   â”‚   â”‚   â”œâ”€â”€ execute_plan_use_case.py
â”‚   â”‚   â”‚   â””â”€â”€ handle_approval_use_case.py
â”‚   â”‚   â”œâ”€â”€ commands/                    # CQRS Commands
â”‚   â”‚   â”‚   â”œâ”€â”€ create_conversation_command.py
â”‚   â”‚   â”‚   â””â”€â”€ add_message_command.py
â”‚   â”‚   â”œâ”€â”€ queries/                     # CQRS Queries
â”‚   â”‚   â”‚   â”œâ”€â”€ get_conversation_query.py
â”‚   â”‚   â”‚   â””â”€â”€ list_conversations_query.py
â”‚   â”‚   â””â”€â”€ dto/                         # Data Transfer Objects
â”‚   â”‚       â”œâ”€â”€ conversation_dto.py
â”‚   â”‚       â””â”€â”€ message_dto.py
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                          # Domain Layer
â”‚   â”‚   â”œâ”€â”€ session_context/             # Bounded Context 1
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation.py      # Renamed from Session
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ message.py
â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_id.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ message_content.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ message_collection.py
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ snapshot_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tool_cleanup_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ conversation_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚   â”‚       â”œâ”€â”€ conversation_started.py
â”‚   â”‚   â”‚       â””â”€â”€ message_added.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ agent_context/               # Bounded Context 2
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ agent_context.py
â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ agent_type.py
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ agent_routing_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ agent_registry.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ agent_context_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚   â”‚       â””â”€â”€ agent_switched.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ execution_context/           # Bounded Context 3
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ execution_plan.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ subtask.py
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ plan_execution_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ subtask_executor.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dependency_resolver.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ plan_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚   â”‚       â””â”€â”€ plan_executed.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ approval_context/            # Bounded Context 4
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ approval_request.py
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ approval_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ hitl_policy_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ approval_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚   â”‚       â””â”€â”€ approval_decided.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ llm_context/                 # Bounded Context 5
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ llm_response.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tool_call.py
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ llm_streaming_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tool_parser_service.py
â”‚   â”‚   â”‚   â””â”€â”€ ports/                   # Ports (Interfaces)
â”‚   â”‚   â”‚       â””â”€â”€ llm_client_port.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ shared/                      # Shared Kernel
â”‚   â”‚       â”œâ”€â”€ base_entity.py
â”‚   â”‚       â”œâ”€â”€ value_object.py
â”‚   â”‚       â”œâ”€â”€ domain_event.py
â”‚   â”‚       â””â”€â”€ repository.py
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/                  # Infrastructure Layer
â”‚   â”‚   â”œâ”€â”€ persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/            # Repository Implementations
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_repository_impl.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ agent_context_repository_impl.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ plan_repository_impl.py
â”‚   â”‚   â”‚   â”œâ”€â”€ models/                  # SQLAlchemy Models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_model.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ message_model.py
â”‚   â”‚   â”‚   â””â”€â”€ mappers/                 # Domain â†” ORM Mappers
â”‚   â”‚   â”‚       â”œâ”€â”€ conversation_mapper.py
â”‚   â”‚   â”‚       â””â”€â”€ message_mapper.py
â”‚   â”‚   â”œâ”€â”€ llm/                         # LLM Adapters
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_client_adapter.py    # Implements LLMClientPort
â”‚   â”‚   â”‚   â””â”€â”€ tool_parser.py
â”‚   â”‚   â”œâ”€â”€ events/                      # Event Infrastructure
â”‚   â”‚   â”‚   â”œâ”€â”€ event_bus.py
â”‚   â”‚   â”‚   â””â”€â”€ event_store.py
â”‚   â”‚   â””â”€â”€ messaging/                   # External Messaging
â”‚   â”‚       â””â”€â”€ gateway_client.py
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                            # Cross-cutting Concerns
â”‚   â”‚   â”œâ”€â”€ config.py                    # Configuration
â”‚   â”‚   â”œâ”€â”€ errors.py                    # Custom Exceptions
â”‚   â”‚   â”œâ”€â”€ logging.py                   # Logging Setup
â”‚   â”‚   â””â”€â”€ di/                          # Dependency Injection (NEW)
â”‚   â”‚       â”œâ”€â”€ container.py             # DI Container
â”‚   â”‚       â”œâ”€â”€ session_module.py        # Session Context DI
â”‚   â”‚       â”œâ”€â”€ agent_module.py          # Agent Context DI
â”‚   â”‚       â”œâ”€â”€ execution_module.py      # Execution Context DI
â”‚   â”‚       â””â”€â”€ infrastructure_module.py # Infrastructure DI
â”‚   â”‚
â”‚   â””â”€â”€ agents/                          # Agent Implementations
â”‚       â”œâ”€â”€ base_agent.py
â”‚       â”œâ”€â”€ orchestrator_agent.py
â”‚       â”œâ”€â”€ coder_agent.py
â”‚       â””â”€â”€ prompts/
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ session_context/
â”‚   â”‚   â”‚   â”œâ”€â”€ agent_context/
â”‚   â”‚   â”‚   â””â”€â”€ execution_context/
â”‚   â”‚   â””â”€â”€ application/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”‚
â””â”€â”€ doc/
    â”œâ”€â”€ architecture/
    â”‚   â”œâ”€â”€ bounded_contexts.md
    â”‚   â”œâ”€â”€ use_cases.md
    â”‚   â””â”€â”€ domain_model.md
    â””â”€â”€ api/
        â””â”€â”€ openapi.yaml
```

### 3.2 ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ

1. **Session â†’ Conversation** â€” Ğ±Ğ¾Ğ»ĞµĞµ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ
2. **Bounded Contexts** â€” ÑĞ²Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°Ğ¼
3. **Use Cases** â€” ÑĞ²Ğ½Ñ‹Ğµ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
4. **Value Objects** â€” Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²Ğ¾Ğ²
5. **DI Modules** â€” Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
6. **Ports** â€” ÑĞ²Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹ Ğ´Ğ»Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼

---

## 4. Key Architectural Decisions

### 4.1 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Bounded Contexts?

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞœĞ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚Ğ½Ñ‹Ğ¹ Domain ÑĞ»Ğ¾Ğ¹ Ñ Ñ€Ğ°Ğ·Ğ¼Ñ‹Ñ‚Ñ‹Ğ¼Ğ¸ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼Ğ¸

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑĞ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ñ‹

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ¼ĞµĞµÑ‚ ÑĞ²Ğ¾Ğ¹ ubiquitous language
- âœ… ĞĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ²Ğ¸Ñ‚Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²
- âœ… Ğ§ĞµÑ‚ĞºĞ¸Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
- âœ… Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
```python
# Session Context â€” Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸
from app.domain.session_context import Conversation, ConversationService

# Agent Context â€” Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ²
from app.domain.agent_context import AgentRoutingService

# Execution Context â€” Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²
from app.domain.execution_context import PlanExecutionService
```

### 4.2 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Use Cases Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¤Ğ°ÑĞ°Ğ´Ğ°?

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** MessageOrchestrationService â€” Ñ„Ğ°ÑĞ°Ğ´ Ğ±ĞµĞ· Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Use Cases Ñ ÑĞ²Ğ½Ğ¾Ğ¹ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Use Case â€” Ğ¾Ğ´Ğ¸Ğ½ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹
- âœ… ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ· Ğ´ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑÑ‚ÑŒ

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ:**
```python
# âŒ Ğ‘Ğ«Ğ›Ğ: Ğ¤Ğ°ÑĞ°Ğ´
class MessageOrchestrationService:
    async def process_message(self, ...):
        # Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² MessageProcessor
        async for chunk in self._message_processor.process(...):
            yield chunk

# âœ… Ğ¡Ğ¢ĞĞ›Ğ: Use Case
class ProcessMessageUseCase:
    async def execute(self, request: ProcessMessageRequest):
        # ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
        conversation = await self.conversation_service.get(request.conversation_id)
        agent = await self.agent_routing_service.route(conversation)
        async for chunk in self.llm_service.stream(agent, conversation):
            yield chunk
```

### 4.3 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Value Objects?

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞŸÑ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (Primitive Obsession)

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Value Objects Ğ´Ğ»Ñ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ
- âœ… ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚
- âœ… Ğ¯Ğ²Ğ½Ğ°Ñ ÑĞµĞ¼Ğ°Ğ½Ñ‚Ğ¸ĞºĞ°
- âœ… Ğ˜Ğ¼Ğ¼ÑƒÑ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
```python
# âŒ Ğ‘Ğ«Ğ›Ğ: ĞŸÑ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²Ñ‹
session_id: str = "session-123"
if not session_id or len(session_id) > 255:
    raise ValueError("Invalid session ID")

# âœ… Ğ¡Ğ¢ĞĞ›Ğ: Value Object
conversation_id = ConversationId("session-123")  # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸
```

### 4.4 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ DI?

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** dependencies.py â€” 814 ÑÑ‚Ñ€Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ DI

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° ÑĞ²Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑÑ‚ÑŒ

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:**
```python
# app/core/di/container.py
class DIContainer:
    def __init__(self):
        self.session_module = SessionModule()
        self.agent_module = AgentModule()
        self.execution_module = ExecutionModule()
        self.infrastructure_module = InfrastructureModule()
    
    def get_process_message_use_case(self) -> ProcessMessageUseCase:
        return ProcessMessageUseCase(
            conversation_service=self.session_module.conversation_service(),
            agent_routing_service=self.agent_module.routing_service(),
            llm_service=self.infrastructure_module.llm_service()
        )
```

### 4.5 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Session Ğ½Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹?

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Session â€” God Object (501 ÑÑ‚Ñ€Ğ¾ĞºĞ°, 20+ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²)

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ğ´Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
- âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑÑ‚ÑŒ
- âœ… ĞœĞµĞ½ÑŒÑˆĞµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ

**Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ:**
```python
# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ÑŒ
class Conversation(Entity):
    """Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ"""
    id: ConversationId
    messages: MessageCollection
    metadata: ConversationMetadata

# Value Object Ğ´Ğ»Ñ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸
class MessageCollection:
    """Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸"""
    def add(self, message: Message) -> None: ...
    def get_recent(self, limit: int) -> List[Message]: ...

# Domain Service Ğ´Ğ»Ñ snapshot
class ConversationSnapshotService:
    """Snapshot/restore Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°"""
    def create_snapshot(self, conversation: Conversation) -> Snapshot: ...
    def restore(self, conversation: Conversation, snapshot: Snapshot) -> None: ...

# Domain Service Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸
class ToolMessageCleanupService:
    """ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° tool messages"""
    def clear_tool_messages(self, conversation: Conversation) -> int: ...
```

---

## 5. Refactoring Plan

### 5.1 Ğ¤Ğ°Ğ·Ñ‹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°

#### **Ğ¤Ğ°Ğ·Ğ° 1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (1-2 Ğ´Ğ½Ñ)**

1. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ĞºĞ»Ğ°ÑÑÑ‹ (Entity, ValueObject, DomainEvent)
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ĞµĞ²
4. âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ DI ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€

#### **Ğ¤Ğ°Ğ·Ğ° 2: Session Context (3-4 Ğ´Ğ½Ñ)**

1. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Conversation entity (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Session)
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ MessageCollection value object
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationId, MessageContent value objects
4. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationService
5. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationSnapshotService
6. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ToolMessageCleanupService
7. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationRepository interface
8. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationRepositoryImpl
9. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ConversationMapper
10. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 3: Agent Context (2-3 Ğ´Ğ½Ñ)**

1. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ AgentType value object
2. âœ… Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ AgentContext entity
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ AgentRoutingService
4. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ AgentRegistry
5. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 4: Use Cases (3-4 Ğ´Ğ½Ñ)**

1. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ProcessMessageUseCase
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ SwitchAgentUseCase
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ProcessToolResultUseCase
4. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ HandleApprovalUseCase
5. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Use Cases
6. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ integration Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 5: Execution Context (2-3 Ğ´Ğ½Ñ)**

1. âœ… Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ ExecutionPlan entity
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ PlanExecutionService
3. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ SubtaskExecutor
4. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 6: Approval Context (2 Ğ´Ğ½Ñ)**

1. âœ… Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ ApprovalRequest entity
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ApprovalService
3. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ HITLPolicyService
4. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 7: LLM Context (2-3 Ğ´Ğ½Ñ)**

1. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ LLMClientPort interface
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ LLMClientAdapter
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ LLMStreamingService
4. âœ… Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ StreamLLMResponseHandler
5. âœ… ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit Ñ‚ĞµÑÑ‚Ñ‹

#### **Ğ¤Ğ°Ğ·Ğ° 8: ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (3-4 Ğ´Ğ½Ñ)**

1. âœ… ĞŸĞ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ¾Ğ²
2. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²
3. âœ… E2E Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
4. âœ… Performance Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
5. âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°

#### **Ğ¤Ğ°Ğ·Ğ° 9: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ (1-2 Ğ´Ğ½Ñ)**

1. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ README
2. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ architecture Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
3. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ API Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
4. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ migration guide

### 5.2 Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** Strangler Fig Pattern

1. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾**
2. **ĞŸĞ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾ Ğ¼Ğ¸Ğ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ**
3. **Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸**

**Ğ­Ñ‚Ğ°Ğ¿Ñ‹:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹                          â”‚
â”‚  â€¢ ĞĞ¾Ğ²Ñ‹Ğµ bounded contexts                                   â”‚
â”‚  â€¢ ĞĞ¾Ğ²Ñ‹Ğµ use cases                                          â”‚
â”‚  â€¢ ĞĞ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ­Ñ‚Ğ°Ğ¿ 2: ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°                                 â”‚
â”‚  â€¢ Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ                           â”‚
â”‚  â€¢ ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ                                    â”‚
â”‚  â€¢ Feature flags Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ­Ñ‚Ğ°Ğ¿ 3: ĞŸĞ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ                                â”‚
â”‚  â€¢ Endpoint Ğ·Ğ° endpoint                                     â”‚
â”‚  â€¢ Use case Ğ·Ğ° use case                                     â”‚
â”‚  â€¢ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑˆĞ°Ğ³Ğµ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°                               â”‚
â”‚  â€¢ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€Ğ¾Ğ²                                       â”‚
â”‚  â€¢ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°ÑĞ°Ğ´Ğ¾Ğ²                                         â”‚
â”‚  â€¢ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° dependencies.py                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğ°

- âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ (100%)
- âœ… ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğµ ÑƒÑ…ÑƒĞ´ÑˆĞ¸Ğ»Ğ°ÑÑŒ
- âœ… API ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ
- âœ… ĞšĞ¾Ğ´ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ > 80%
- âœ… Ğ¦Ğ¸ĞºĞ»Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ < 10 Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²
- âœ… ĞĞµÑ‚ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² > 300 ÑÑ‚Ñ€Ğ¾Ğº
- âœ… ĞĞµÑ‚ ĞºĞ»Ğ°ÑÑĞ¾Ğ² > 200 ÑÑ‚Ñ€Ğ¾Ğº
- âœ… ĞĞµÑ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ² > 50 ÑÑ‚Ñ€Ğ¾Ğº

---

## 6. Compatibility Guarantees

### 6.1 API ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ (100% ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)

#### **REST API Endpoints**

```yaml
# âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: Ğ’ÑĞµ endpoints ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹

# Sessions (Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² Conversations Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸, Ğ½Ğ¾ API Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ)
POST   /sessions
GET    /sessions
GET    /sessions/{session_id}
GET    /sessions/{session_id}/history
GET    /sessions/{session_id}/pending-approvals

# Messages
POST   /agent/message/stream
POST   /sessions/{session_id}/tool-result
POST   /sessions/{session_id}/hitl-decision
POST   /sessions/{session_id}/plan-decision

# Agents
GET    /agents
GET    /agents/{session_id}/current
POST   /agents/{session_id}/switch

# Events
GET    /events/metrics
GET    /events/audit-log
```

#### **Request/Response Schemas**

```python
# âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: Ğ’ÑĞµ Pydantic ÑÑ…ĞµĞ¼Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ

# ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: CreateSessionRequest
class CreateSessionRequest(BaseModel):
    session_id: Optional[str] = None  # ĞĞµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ

# ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: StreamChunk
class StreamChunk(BaseModel):
    type: str
    content: Optional[str] = None
    token: Optional[str] = None
    is_final: bool = False
    # ... Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ
```

### 6.2 Gateway â†” Agent Runtime Protocol

```json
// âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

// User message
{
  "session_id": "session-123",
  "role": "user",
  "content": "Create a widget",
  "agent_type": "coder"
}

// Assistant message (streaming)
{
  "type": "assistant_message",
  "session_id": "session-123",
  "token": "Creating ",
  "is_final": false
}

// Tool call
{
  "type": "tool_call",
  "call_id": "call_123",
  "tool_name": "write_file",
  "arguments": {"path": "widget.py", "content": "..."}
}

// Tool result
{
  "session_id": "session-123",
  "call_id": "call_123",
  "result": "File created successfully"
}
```

### 6.3 Agent Runtime â†” LLM Proxy Protocol

```json
// âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: OpenAI-compatible API

// Request
POST /v1/chat/completions
{
  "model": "gpt-4",
  "messages": [
    {"role": "user", "content": "Hello"}
  ],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "write_file",
        "parameters": {...}
      }
    }
  ]
}

// Response
{
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "...",
        "tool_calls": [...]
      }
    }
  ]
}
```

### 6.4 Database Schema

```sql
-- âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: Ğ’ÑĞµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ

-- sessions table (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ² conversations, Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ)
CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    title VARCHAR(500),
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_activity TIMESTAMP
);

-- messages table
CREATE TABLE messages (
    id VARCHAR(255) PRIMARY KEY,
    session_id VARCHAR(255),
    role VARCHAR(50),
    content TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);

-- agent_contexts table
CREATE TABLE agent_contexts (
    id VARCHAR(255) PRIMARY KEY,
    session_id VARCHAR(255),
    current_agent VARCHAR(50),
    switch_count INTEGER,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
```

### 6.5 Event Types

```python
# âœ… ĞĞ•Ğ˜Ğ—ĞœĞ•ĞĞĞ: Ğ’ÑĞµ Ñ‚Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ

class EventType(str, Enum):
    # Session events
    SESSION_CREATED = "session_created"
    MESSAGE_ADDED = "message_added"
    SESSION_DEACTIVATED = "session_deactivated"
    
    # Agent events
    AGENT_SWITCHED = "agent_switched"
    AGENT_PROCESSING_STARTED = "agent_processing_started"
    AGENT_PROCESSING_COMPLETED = "agent_processing_completed"
    
    # Tool events
    TOOL_EXECUTION_REQUESTED = "tool_execution_requested"
    TOOL_APPROVAL_REQUIRED = "tool_approval_required"
    
    # ... Ğ²ÑĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ
```

### 6.6 Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

1. **API Gateway Pattern**
   ```python
   # Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ API â†’ ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
   @router.post("/sessions")
   async def create_session(request: CreateSessionRequest):
       # ĞĞ´Ğ°Ğ¿Ñ‚ĞµÑ€: ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ â†’ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ use case
       use_case = container.get_create_conversation_use_case()
       result = await use_case.execute(
           CreateConversationCommand(conversation_id=request.session_id)
       )
       # ĞĞ´Ğ°Ğ¿Ñ‚ĞµÑ€: Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â†’ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
       return CreateSessionResponse(
           id=result.id.value,  # ConversationId â†’ str
           created_at=result.created_at,
           is_active=result.is_active
       )
   ```

2. **Database Migration Strategy**
   ```python
   # Alembic migration Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
   def upgrade():
       # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
       op.create_table('conversations', ...)
       
       # Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
       op.execute('INSERT INTO conversations SELECT * FROM sessions')
       
       # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ view Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
       op.execute('CREATE VIEW sessions AS SELECT * FROM conversations')
   
   def downgrade():
       op.drop_view('sessions')
       op.drop_table('conversations')
   ```

3. **Event Compatibility Layer**
   ```python
   # ĞĞ´Ğ°Ğ¿Ñ‚ĞµÑ€ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
   class EventAdapter:
       def adapt_old_to_new(self, old_event: SessionCreated) -> ConversationStarted:
           return ConversationStarted(
               conversation_id=ConversationId(old_event.session_id),
               created_at=old_event.created_at
           )
       
       def adapt_new_to_old(self, new_event: ConversationStarted) -> SessionCreated:
           return SessionCreated(
               session_id=new_event.conversation_id.value,
               created_at=new_event.created_at
           )
   ```

---

## 7. Final Notes

### 7.1 ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

1. **ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ñ‚Ğ°**
   - âœ… Ğ¡Ñ‚Ñ€Ğ¾Ğ³Ğ¾Ğµ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ Clean Architecture
   - âœ… Ğ¯Ğ²Ğ½Ñ‹Ğµ Bounded Contexts
   - âœ… Dependency Rule ÑĞ¾Ğ±Ğ»ÑĞ´Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° 100%

2. **Ğ¡Ğ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ¶Ğ´Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ**
   - âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ < 200 ÑÑ‚Ñ€Ğ¾Ğº
   - âœ… ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ < 50 ÑÑ‚Ñ€Ğ¾Ğº
   - âœ… Ğ¦Ğ¸ĞºĞ»Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ < 10

3. **Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ**
   - âœ… Ğ’ÑĞµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
   - âœ… Ğ›ĞµĞ³ĞºĞ¾ Ğ¼Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
   - âœ… Unit Ñ‚ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°

4. **Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ**
   - âœ… ĞĞ¾Ğ²Ñ‹Ğµ bounded contexts Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ
   - âœ… ĞĞ¾Ğ²Ñ‹Ğµ use cases Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ
   - âœ… ĞĞ¾Ğ²Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ

5. **ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ**
   - âœ… ĞœĞµĞ½ÑŒÑˆĞµ ÑĞ»Ğ¾ĞµĞ² Ğ´ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
   - âœ… ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ² use cases
   - âœ… ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ‘Ğ”

### 7.2 ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | Ğ”Ğ¾ | ĞŸĞ¾ÑĞ»Ğµ | Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ |
|---------|-----|-------|-----------|
| Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ĞºĞ»Ğ°ÑÑĞ° | 350 ÑÑ‚Ñ€Ğ¾Ğº | 120 ÑÑ‚Ñ€Ğ¾Ğº | -66% |
| ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ĞºĞ»Ğ°ÑÑĞ° | 814 ÑÑ‚Ñ€Ğ¾Ğº | 200 ÑÑ‚Ñ€Ğ¾Ğº | -75% |
| Ğ¦Ğ¸ĞºĞ»Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ | 15-20 | 5-8 | -60% |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ | 10-15 | 3-5 | -65% |
| ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸ | 70% | 85%+ | +15% |
| Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ² | 45 ÑĞµĞº | 30 ÑĞµĞº | -33% |

### 7.3 Ğ Ğ¸ÑĞºĞ¸ Ğ¸ Ğ¼Ğ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ

| Ğ Ğ¸ÑĞº | Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ’Ğ»Ğ¸ÑĞ½Ğ¸Ğµ | ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ |
|------|-------------|---------|-----------|
| ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ API ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ¾Ğ² | ĞĞ¸Ğ·ĞºĞ°Ñ | ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ | ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ‚ĞµÑÑ‚Ñ‹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ¾Ğ² |
| Ğ ĞµĞ³Ñ€ĞµÑÑĞ¸Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ | E2E Ñ‚ĞµÑÑ‚Ñ‹, Ğ¿Ğ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ |
| Ğ¡Ğ½Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ | Performance Ñ‚ĞµÑÑ‚Ñ‹, Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
| Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ | Ğ§ĞµÑ‚ĞºĞ¸Ğ¹ Ğ¿Ğ»Ğ°Ğ½, Ñ„Ğ°Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ |

### 7.4 Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. **ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾:**
   - âœ… Ğ£Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½
   - âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ feature branch
   - âœ… ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¤Ğ°Ğ·Ñƒ 1 (ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°)

2. **ĞšÑ€Ğ°Ñ‚ĞºĞ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ (1-2 Ğ½ĞµĞ´ĞµĞ»Ğ¸):**
   - âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¤Ğ°Ğ·Ñ‹ 2-4 (Session, Agent, Use Cases)
   - âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ code review
   - âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ

3. **Ğ¡Ñ€ĞµĞ´Ğ½ĞµÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ (3-4 Ğ½ĞµĞ´ĞµĞ»Ğ¸):**
   - âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ¤Ğ°Ğ·Ñ‹ 5-7 (Execution, Approval, LLM)
   - âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ
   - âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°

4. **Ğ”Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ (1-2 Ğ¼ĞµÑÑÑ†Ğ°):**
   - âœ… ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ production
   - âœ… ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
   - âœ… Ğ”Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ¸Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

### 7.5 Event-Based Architecture â€” Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğº Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ

#### ğŸ¯ Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° **ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚** Event-Driven Architecture:
```python
# Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ EventBus
from app.events.event_bus import event_bus

# Ğ”Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
await event_bus.publish(
    SessionCreated(session_id=session_id)
)
```

ĞĞ´Ğ½Ğ°ĞºĞ¾, **ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¹** Ğ¸Ğ·-Ğ·Ğ°:
1. ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
2. Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
3. Tight coupling Ñ‡ĞµÑ€ĞµĞ· dependency injection

#### âœ… ĞšĞ°Ğº Ğ½Ğ¾Ğ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑƒĞ¿Ñ€Ğ¾Ñ‰Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° Event-Based

**1. Bounded Contexts = Natural Event Boundaries**

```python
# âœ… ĞŸĞĞ¡Ğ›Ğ• Ğ Ğ•Ğ¤ĞĞšĞ¢ĞĞ Ğ˜ĞĞ“Ğ: ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ â€” Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ

# Session Context Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
class ConversationService:
    async def create_conversation(self, id: ConversationId) -> Conversation:
        conversation = Conversation(id=id)
        await self._repository.save(conversation)
        
        # ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°
        await self._event_bus.publish(
            ConversationStarted(
                conversation_id=id,
                timestamp=datetime.now(timezone.utc)
            )
        )
        return conversation

# Agent Context Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
class AgentContextSubscriber:
    @event_bus.subscribe(event_type=EventType.CONVERSATION_STARTED)
    async def on_conversation_started(self, event: ConversationStarted):
        # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
        await self._agent_service.initialize_context(
            conversation_id=event.conversation_id
        )
```

**2. Use Cases â†’ Event Handlers**

```python
# âœ… Ğ›ĞµĞ³ĞºĞ¾ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Use Cases Ğ² Event Handlers

# Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Use Case (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹)
class ProcessMessageUseCase:
    async def execute(self, request: ProcessMessageRequest):
        conversation = await self.conversation_service.get(request.conversation_id)
        agent = await self.agent_routing_service.route(conversation)
        async for chunk in self.llm_service.stream(agent, conversation):
            yield chunk

# Event-Based Ğ²ĞµÑ€ÑĞ¸Ñ (Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ)
class MessageReceivedHandler:
    @event_bus.subscribe(event_type=EventType.MESSAGE_RECEIVED)
    async def handle(self, event: MessageReceived):
        # ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
        conversation = await self.conversation_service.get(event.conversation_id)
        agent = await self.agent_routing_service.route(conversation)
        
        # ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ³Ğ¾ streaming
        await self._event_bus.publish(
            AgentProcessingStarted(
                conversation_id=event.conversation_id,
                agent_type=agent.type
            )
        )
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°...
        
        await self._event_bus.publish(
            AgentProcessingCompleted(
                conversation_id=event.conversation_id,
                result=result
            )
        )
```

**3. Saga Pattern Ğ´Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… workflow**

```python
# âœ… Bounded Contexts Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑÑ‚ Ğ»ĞµĞ³ĞºĞ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Saga

class PlanExecutionSaga:
    """ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ½Ğ° Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"""
    
    def __init__(self, event_bus: EventBus):
        self._event_bus = event_bus
        self._register_handlers()
    
    def _register_handlers(self):
        # Ğ¨Ğ°Ğ³ 1: ĞŸĞ»Ğ°Ğ½ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½
        self._event_bus.subscribe(
            event_type=EventType.PLAN_APPROVED,
            handler=self._on_plan_approved
        )
        
        # Ğ¨Ğ°Ğ³ 2: Subtask Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°
        self._event_bus.subscribe(
            event_type=EventType.SUBTASK_COMPLETED,
            handler=self._on_subtask_completed
        )
        
        # Ğ¨Ğ°Ğ³ 3: ĞŸĞ»Ğ°Ğ½ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½
        self._event_bus.subscribe(
            event_type=EventType.PLAN_COMPLETED,
            handler=self._on_plan_completed
        )
    
    async def _on_plan_approved(self, event: PlanApproved):
        # ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ subtask
        await self._event_bus.publish(
            SubtaskExecutionRequested(
                plan_id=event.plan_id,
                subtask_id=event.first_subtask_id
            )
        )
    
    async def _on_subtask_completed(self, event: SubtaskCompleted):
        # ĞĞ°Ğ¹Ñ‚Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ subtask
        next_subtask = await self._find_next_subtask(event.plan_id)
        
        if next_subtask:
            await self._event_bus.publish(
                SubtaskExecutionRequested(
                    plan_id=event.plan_id,
                    subtask_id=next_subtask.id
                )
            )
        else:
            await self._event_bus.publish(
                PlanCompleted(plan_id=event.plan_id)
            )
```

**4. Event Sourcing Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ**

```python
# âœ… Bounded Contexts ÑƒĞ¿Ñ€Ğ¾Ñ‰Ğ°ÑÑ‚ Event Sourcing

class ConversationEventStore:
    """Event Store Ğ´Ğ»Ñ Session Context"""
    
    async def save_event(self, event: DomainEvent) -> None:
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Ğ‘Ğ”
        await self._repository.save_event(event)
    
    async def get_events(self, conversation_id: ConversationId) -> List[DomainEvent]:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ conversation
        return await self._repository.get_events(conversation_id)
    
    async def rebuild_state(self, conversation_id: ConversationId) -> Conversation:
        # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
        events = await self.get_events(conversation_id)
        
        conversation = Conversation(id=conversation_id)
        for event in events:
            conversation.apply_event(event)
        
        return conversation
```

**5. CQRS Ñ Event-Based ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹**

```python
# âœ… Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Write/Read Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ

# Write Model (Command Side)
class ConversationWriteModel:
    async def add_message(self, conversation_id: ConversationId, message: Message):
        conversation = await self._repository.get(conversation_id)
        conversation.add_message(message)
        await self._repository.save(conversation)
        
        # ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Read Model
        await self._event_bus.publish(
            MessageAdded(
                conversation_id=conversation_id,
                message_id=message.id,
                content=message.content
            )
        )

# Read Model (Query Side) â€” Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
class ConversationReadModelProjection:
    @event_bus.subscribe(event_type=EventType.MESSAGE_ADDED)
    async def on_message_added(self, event: MessageAdded):
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Read Model
        await self._read_repository.add_message_to_projection(
            conversation_id=event.conversation_id,
            message_data={
                "id": event.message_id,
                "content": event.content,
                "timestamp": event.timestamp
            }
        )
```

#### ğŸ“Š Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ: Ğ”Ğ¾ Ğ¸ ĞŸĞ¾ÑĞ»Ğµ

| ĞÑĞ¿ĞµĞºÑ‚ | Ğ”Ğ¾ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° | ĞŸĞ¾ÑĞ»Ğµ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° | Event-Based (Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ) |
|--------|-----------------|--------------------|-----------------------|
| **Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ** | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ (Ğ¿Ñ€ÑĞ¼Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹) | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ (DI) | ĞĞ¸Ğ·ĞºĞ°Ñ (ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ) |
| **ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ** | ĞœĞ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚ | ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚ | ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ |
| **ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ** | Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ | Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| **ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ** | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ |
| **Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ** | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ (God Objects) | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ (Bounded Contexts) | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ (Event Handlers) |

#### ğŸš€ Roadmap Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Event-Based

**Ğ¤Ğ°Ğ·Ğ° 1: Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ (3-4 Ğ½ĞµĞ´ĞµĞ»Ğ¸)**
- âœ… Bounded Contexts
- âœ… Use Cases
- âœ… Value Objects
- âœ… ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ DI

**Ğ¤Ğ°Ğ·Ğ° 2: Hybrid Architecture (1-2 Ğ¼ĞµÑÑÑ†Ğ°)**
- âœ… ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
- âœ… Saga Ğ´Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… workflow
- âœ… Event Store Ğ´Ğ»Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ°
- âš ï¸ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Use Cases Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ

**Ğ¤Ğ°Ğ·Ğ° 3: Full Event-Based (3-6 Ğ¼ĞµÑÑÑ†ĞµĞ²)**
- âœ… Ğ’ÑĞµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
- âœ… Event Sourcing Ğ´Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²
- âœ… CQRS Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
- âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼

#### ğŸ’¡ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ñ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ´Ğ»Ñ Event-Based

1. **Bounded Contexts = Natural Service Boundaries**
   - ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼
   - Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ â€” ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± ĞºĞ¾Ğ¼Ğ¼ÑƒĞ½Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

2. **Use Cases Ğ»ĞµĞ³ĞºĞ¾ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² Event Handlers**
   - ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°
   - Ğ¢Ğ° Ğ¶Ğµ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

3. **Value Objects Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ÑÑ‚ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ**
   - Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
   - ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ

4. **ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ DI ÑƒĞ¿Ñ€Ğ¾Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**
   - Event Handlers Ğ»ĞµĞ³ĞºĞ¾ Ğ¼Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
   - Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ñ‰Ğµ

5. **Ğ¯Ğ²Ğ½Ñ‹Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²**
   - Ğ§ĞµÑ‚ĞºĞ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
   - Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

#### ğŸ¯ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸: ProcessMessage

```python
# âŒ Ğ”Ğ: ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹
class MessageOrchestrationService:
    async def process_message(self, session_id: str, message: str):
        session = await self.session_service.get(session_id)
        context = await self.agent_service.get_context(session_id)
        agent = self.agent_router.get_agent(context.current_agent)
        async for chunk in agent.process(session_id, message, ...):
            yield chunk

# âœ… ĞŸĞĞ¡Ğ›Ğ• Ğ Ğ•Ğ¤ĞĞšĞ¢ĞĞ Ğ˜ĞĞ“Ğ: Use Case
class ProcessMessageUseCase:
    async def execute(self, request: ProcessMessageRequest):
        conversation = await self.conversation_service.get(request.conversation_id)
        agent = await self.agent_routing_service.route(conversation)
        async for chunk in self.llm_service.stream(agent, conversation):
            yield chunk

# ğŸš€ Ğ‘Ğ£Ğ”Ğ£Ğ©Ğ•Ğ•: Event-Based
class MessageReceivedHandler:
    @event_bus.subscribe(event_type=EventType.MESSAGE_RECEIVED)
    async def handle(self, event: MessageReceived):
        # ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ñ€ÑĞ¼Ñ‹Ñ… Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        await self._event_bus.publish(
            ProcessingStarted(conversation_id=event.conversation_id)
        )
        
        # ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
        result = await self._process_async(event)
        
        await self._event_bus.publish(
            ProcessingCompleted(
                conversation_id=event.conversation_id,
                result=result
            )
        )
```

#### âœ… Ğ’Ñ‹Ğ²Ğ¾Ğ´

ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° **Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½Ğ°** Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Event-Based:

1. âœ… **Bounded Contexts** â€” ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
2. âœ… **Use Cases** â€” Ğ»ĞµĞ³ĞºĞ¾ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² Event Handlers
3. âœ… **Value Objects** â€” Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ÑÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
4. âœ… **ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ DI** â€” ÑƒĞ¿Ñ€Ğ¾Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Event Handlers
5. âœ… **Ğ¯Ğ²Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹** â€” Ñ‡ĞµÑ‚ĞºĞ¸Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

**ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ñ‹Ğ¼:**
- ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Saga Ğ´Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… workflow
- ĞŸĞ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾ Ğ¼Ğ¸Ğ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Use Cases
- Ğ’ Ğ¸Ñ‚Ğ¾Ğ³Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ event-driven ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ

**Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚ÑÑ Ğ½Ğ° 80-90%** Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° Event-Based Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ.

---

### 7.6 Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ±Ğ¾Ğ¹ **Ğ³Ğ»ÑƒĞ±Ğ¾ĞºÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½ÑƒÑ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ**, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ:

1. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ 100% Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ** â€” Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ Ğ½ĞµĞ¸Ğ·Ğ¼ĞµĞ½Ğ½Ñ‹
2. **Ğ£Ğ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ½Ğ° 60-75%** â€” Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ´Ğ°
3. **Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ** â€” ÑĞ²Ğ½Ñ‹Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹, Ğ¼Ğ°Ğ»Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
4. **Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ Ğº Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼Ñƒ** â€” Ğ»ĞµĞ³ĞºĞ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑÑ‚ÑŒ Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
5. **ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿ÑƒÑ‚ÑŒ Ğº Event-Based** â€” ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¸Ğµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° 80-90%

Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ÑĞ»ĞµĞ´ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ°Ğ¼:
- âœ… **Clean Architecture** â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾Ğµ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ¾ĞµĞ²
- âœ… **Domain-Driven Design** â€” ÑĞ²Ğ½Ñ‹Ğµ bounded contexts
- âœ… **SOLID** â€” ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ğ´Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
- âœ… **KISS** â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµ Ğ²ÑĞµĞ³Ğ¾
- âœ… **DRY** â€” Ğ½ĞµÑ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- âœ… **Event-Driven Ready** â€” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğº event-based Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğµ

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ:** ĞŸÑ€Ğ¸ÑÑ‚ÑƒĞ¿Ğ¸Ñ‚ÑŒ Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, ÑĞ»ĞµĞ´ÑƒÑ Ñ„Ğ°Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ»Ğ°Ğ½Ñƒ.

---

**ĞĞ²Ñ‚Ğ¾Ñ€:** Sergey Penkovsky
**Ğ”Ğ°Ñ‚Ğ°:** 4 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 2026  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
