# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Agent Runtime Service

**–¶–µ–ª—å:** –°—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∫–æ–¥–æ–≤—É—é –±–∞–∑—É –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 18 —è–Ω–≤–∞—Ä—è 2026
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 20 —è–Ω–≤–∞—Ä—è 2026
**–í–µ—Ä—Å–∏—è:** 2.0 (–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **75% –ó–ê–í–ï–†–®–ï–ù–û** - –û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

---

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

---

## üìä –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–æ–±–ª–µ–º—ã)

```
app/
‚îú‚îÄ‚îÄ agents/              # ‚úÖ –•–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ
‚îú‚îÄ‚îÄ api/v1/             
‚îÇ   ‚îî‚îÄ‚îÄ endpoints.py     # ‚ùå 823 —Å—Ç—Ä–æ–∫–∏ - —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ core/               # ‚úÖ –•–æ—Ä–æ—à–æ
‚îú‚îÄ‚îÄ events/             # ‚úÖ –•–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ
‚îú‚îÄ‚îÄ middleware/         # ‚úÖ –•–æ—Ä–æ—à–æ
‚îú‚îÄ‚îÄ models/             # ‚ö†Ô∏è –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ services/           # ‚ö†Ô∏è –°–º–µ—à–∞–Ω—ã —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    ‚îú‚îÄ‚îÄ agent_context_async.py      # 505 —Å—Ç—Ä–æ–∫
    ‚îú‚îÄ‚îÄ session_manager_async.py    # 463 —Å—Ç—Ä–æ–∫–∏
    ‚îú‚îÄ‚îÄ database.py                 # 1094 —Å—Ç—Ä–æ–∫–∏ - —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
    ‚îú‚îÄ‚îÄ multi_agent_orchestrator.py # 320 —Å—Ç—Ä–æ–∫
    ‚îî‚îÄ‚îÄ ...
```

### –ü—Ä–æ–±–ª–µ–º—ã:
1. **–ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã** - —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
2. **–°–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–µ–ª–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** - sync/async –æ–±–µ—Ä—Ç–∫–∏
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–µ–≤** - –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è domain/infrastructure

---

## üèóÔ∏è –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Clean Architecture + DDD)

```
app/
‚îú‚îÄ‚îÄ domain/                    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ entities/             # –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_context.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message.py
‚îÇ   ‚îú‚îÄ‚îÄ repositories/         # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_repository.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ context_repository.py
‚îÇ   ‚îú‚îÄ‚îÄ services/             # –î–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_orchestration.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session_management.py
‚îÇ   ‚îî‚îÄ‚îÄ events/               # –î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ session_events.py
‚îÇ       ‚îî‚îÄ‚îÄ agent_events.py
‚îÇ
‚îú‚îÄ‚îÄ application/              # –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ commands/            # Command handlers (CQRS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_session.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add_message.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ switch_agent.py
‚îÇ   ‚îú‚îÄ‚îÄ queries/             # Query handlers (CQRS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_session.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_history.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ list_sessions.py
‚îÇ   ‚îî‚îÄ‚îÄ dto/                 # Data Transfer Objects
‚îÇ       ‚îú‚îÄ‚îÄ session_dto.py
‚îÇ       ‚îî‚îÄ‚îÄ message_dto.py
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/           # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ (REFACTORED)
‚îÇ   ‚îú‚îÄ‚îÄ persistence/         # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/   # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/     # Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ events/             # Event Bus —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bus.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscribers/
‚îÇ   ‚îú‚îÄ‚îÄ llm/                # LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ streaming.py
‚îÇ   ‚îî‚îÄ‚îÄ cache/              # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (NEW)
‚îÇ       ‚îî‚îÄ‚îÄ redis_cache.py
‚îÇ
‚îú‚îÄ‚îÄ api/                     # Presentation layer (REFACTORED)
‚îÇ   ‚îú‚îÄ‚îÄ v1/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/        # –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sessions.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agents.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/        # Request/Response —Å—Ö–µ–º—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_schemas.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message_schemas.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py # API-specific dependencies
‚îÇ   ‚îî‚îÄ‚îÄ middleware/
‚îÇ
‚îú‚îÄ‚îÄ agents/                  # –ê–≥–µ–Ω—Ç—ã (KEEP AS IS)
‚îÇ   ‚îú‚îÄ‚îÄ base_agent.py
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator_agent.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ core/                    # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (ENHANCED)
    ‚îú‚îÄ‚îÄ config.py
    ‚îú‚îÄ‚îÄ dependencies.py
    ‚îú‚îÄ‚îÄ errors.py           # NEW - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    ‚îî‚îÄ‚îÄ logging.py          # NEW - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```

---

## üìã –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ—ç—Ç–∞–ø–Ω—ã–π)

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 –¥–Ω—è)

#### 1.1. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```bash
mkdir -p app/domain/{entities,repositories,services,events}
mkdir -p app/application/{commands,queries,dto}
mkdir -p app/infrastructure/{persistence/{models,repositories,migrations},events/subscribers,llm,cache}
mkdir -p app/api/v1/{routers,schemas}
```

#### 1.2. –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

**`app/domain/entities/base.py`**
```python
from abc import ABC
from datetime import datetime
from typing import Optional
from pydantic import BaseModel, Field

class Entity(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è –¥–æ–º–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å"""
    id: str
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: Optional[datetime] = None
    
    class Config:
        arbitrary_types_allowed = True
```

**`app/domain/repositories/base.py`**
```python
from abc import ABC, abstractmethod
from typing import Generic, TypeVar, Optional, List

T = TypeVar('T')

class Repository(ABC, Generic[T]):
    """–ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"""
    
    @abstractmethod
    async def get(self, id: str) -> Optional[T]:
        pass
    
    @abstractmethod
    async def save(self, entity: T) -> None:
        pass
    
    @abstractmethod
    async def delete(self, id: str) -> bool:
        pass
    
    @abstractmethod
    async def list(self, limit: int = 100, offset: int = 0) -> List[T]:
        pass
```

#### 1.3. –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

**`app/core/errors.py`**
```python
class DomainError(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ"""
    pass

class SessionNotFoundError(DomainError):
    """–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"""
    pass

class AgentSwitchError(DomainError):
    """–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞"""
    pass

class ConcurrencyError(DomainError):
    """–û—à–∏–±–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞"""
    pass
```

### –≠—Ç–∞–ø 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Domain Layer (3-4 –¥–Ω—è)

#### 2.1. –°–æ–∑–¥–∞—Ç—å –¥–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

**`app/domain/entities/session.py`**
```python
from typing import List, Optional
from datetime import datetime
from .base import Entity
from .message import Message

class Session(Entity):
    """–î–æ–º–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏"""
    
    messages: List[Message] = []
    title: Optional[str] = None
    description: Optional[str] = None
    last_activity: datetime
    is_active: bool = True
    
    def add_message(self, message: Message) -> None:
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏—é"""
        self.messages.append(message)
        self.last_activity = datetime.utcnow()
        self.updated_at = datetime.utcnow()
    
    def get_recent_messages(self, limit: int = 10) -> List[Message]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π"""
        return self.messages[-limit:]
    
    def deactivate(self) -> None:
        """–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é"""
        self.is_active = False
        self.updated_at = datetime.utcnow()
```

**`app/domain/entities/agent_context.py`**
```python
from typing import List, Dict, Any, Optional
from datetime import datetime
from enum import Enum
from .base import Entity

class AgentType(str, Enum):
    ORCHESTRATOR = "orchestrator"
    CODER = "coder"
    ARCHITECT = "architect"
    DEBUG = "debug"
    ASK = "ask"

class AgentSwitch:
    """–ó–∞–ø–∏—Å—å –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞"""
    from_agent: AgentType
    to_agent: AgentType
    reason: str
    timestamp: datetime

class AgentContext(Entity):
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Å–µ—Å—Å–∏–∏"""
    
    session_id: str
    current_agent: AgentType = AgentType.ORCHESTRATOR
    switch_history: List[AgentSwitch] = []
    metadata: Dict[str, Any] = {}
    
    def switch_to(self, target_agent: AgentType, reason: str) -> None:
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞"""
        if self.current_agent == target_agent:
            return
        
        switch = AgentSwitch(
            from_agent=self.current_agent,
            to_agent=target_agent,
            reason=reason,
            timestamp=datetime.utcnow()
        )
        
        self.switch_history.append(switch)
        self.current_agent = target_agent
        self.updated_at = datetime.utcnow()
    
    def can_switch_to(self, target_agent: AgentType) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è"""
        # –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        if len(self.switch_history) >= 10:
            return False  # –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
        return True
```

#### 2.2. –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

**`app/domain/repositories/session_repository.py`**
```python
from abc import abstractmethod
from typing import List, Optional
from .base import Repository
from ..entities.session import Session

class SessionRepository(Repository[Session]):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π"""
    
    @abstractmethod
    async def find_by_id(self, session_id: str) -> Optional[Session]:
        """–ù–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ ID"""
        pass
    
    @abstractmethod
    async def find_active(self, limit: int = 100) -> List[Session]:
        """–ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏"""
        pass
    
    @abstractmethod
    async def cleanup_old(self, max_age_hours: int = 24) -> int:
        """–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏"""
        pass
```

#### 2.3. –°–æ–∑–¥–∞—Ç—å –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

**`app/domain/services/session_management.py`**
```python
from typing import Optional
from ..entities.session import Session
from ..entities.message import Message
from ..repositories.session_repository import SessionRepository
from ...core.errors import SessionNotFoundError

class SessionManagementService:
    """–î–æ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏"""
    
    def __init__(self, repository: SessionRepository):
        self._repository = repository
    
    async def create_session(self, session_id: str) -> Session:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é"""
        session = Session(
            id=session_id,
            last_activity=datetime.utcnow()
        )
        await self._repository.save(session)
        return session
    
    async def add_message(
        self, 
        session_id: str, 
        message: Message
    ) -> Session:
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏—é"""
        session = await self._repository.find_by_id(session_id)
        if not session:
            raise SessionNotFoundError(f"Session {session_id} not found")
        
        session.add_message(message)
        await self._repository.save(session)
        return session
    
    async def get_session(self, session_id: str) -> Session:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é"""
        session = await self._repository.find_by_id(session_id)
        if not session:
            raise SessionNotFoundError(f"Session {session_id} not found")
        return session
```

### –≠—Ç–∞–ø 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Application Layer (2-3 –¥–Ω—è)

#### 3.1. –°–æ–∑–¥–∞—Ç—å Command Handlers (CQRS)

**`app/application/commands/create_session.py`**
```python
from dataclasses import dataclass
from ...domain.services.session_management import SessionManagementService
from ...domain.entities.session import Session

@dataclass
class CreateSessionCommand:
    """–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    session_id: str
    system_prompt: Optional[str] = None

class CreateSessionHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    
    def __init__(self, session_service: SessionManagementService):
        self._service = session_service
    
    async def handle(self, command: CreateSessionCommand) -> Session:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É"""
        return await self._service.create_session(command.session_id)
```

**`app/application/commands/add_message.py`**
```python
from dataclasses import dataclass
from ...domain.services.session_management import SessionManagementService
from ...domain.entities.message import Message

@dataclass
class AddMessageCommand:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
    session_id: str
    role: str
    content: str
    name: Optional[str] = None

class AddMessageHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
    
    def __init__(self, session_service: SessionManagementService):
        self._service = session_service
    
    async def handle(self, command: AddMessageCommand) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É"""
        message = Message(
            role=command.role,
            content=command.content,
            name=command.name
        )
        await self._service.add_message(command.session_id, message)
```

#### 3.2. –°–æ–∑–¥–∞—Ç—å Query Handlers (CQRS)

**`app/application/queries/get_session.py`**
```python
from dataclasses import dataclass
from typing import Optional
from ...domain.repositories.session_repository import SessionRepository
from ..dto.session_dto import SessionDTO

@dataclass
class GetSessionQuery:
    """–ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    session_id: str

class GetSessionHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    
    def __init__(self, repository: SessionRepository):
        self._repository = repository
    
    async def handle(self, query: GetSessionQuery) -> Optional[SessionDTO]:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å"""
        session = await self._repository.find_by_id(query.session_id)
        if not session:
            return None
        
        return SessionDTO.from_entity(session)
```

#### 3.3. –°–æ–∑–¥–∞—Ç—å DTO

**`app/application/dto/session_dto.py`**
```python
from typing import List, Optional
from datetime import datetime
from pydantic import BaseModel
from ...domain.entities.session import Session

class SessionDTO(BaseModel):
    """DTO –¥–ª—è —Å–µ—Å—Å–∏–∏"""
    
    id: str
    title: Optional[str]
    message_count: int
    last_activity: datetime
    is_active: bool
    
    @classmethod
    def from_entity(cls, session: Session) -> "SessionDTO":
        """–°–æ–∑–¥–∞—Ç—å DTO –∏–∑ —Å—É—â–Ω–æ—Å—Ç–∏"""
        return cls(
            id=session.id,
            title=session.title,
            message_count=len(session.messages),
            last_activity=session.last_activity,
            is_active=session.is_active
        )
```

### –≠—Ç–∞–ø 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Infrastructure Layer (3-4 –¥–Ω—è)

#### 4.1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

**`app/infrastructure/persistence/repositories/session_repository_impl.py`**
```python
from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from ....domain.repositories.session_repository import SessionRepository
from ....domain.entities.session import Session
from ..models.session_model import SessionModel
from ..mappers.session_mapper import SessionMapper

class SessionRepositoryImpl(SessionRepository):
    """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π"""
    
    def __init__(self, db: AsyncSession):
        self._db = db
        self._mapper = SessionMapper()
    
    async def find_by_id(self, session_id: str) -> Optional[Session]:
        """–ù–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ ID"""
        result = await self._db.execute(
            select(SessionModel).where(SessionModel.id == session_id)
        )
        model = result.scalar_one_or_none()
        
        if not model:
            return None
        
        return self._mapper.to_entity(model)
    
    async def save(self, session: Session) -> None:
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é"""
        model = self._mapper.to_model(session)
        self._db.add(model)
        await self._db.commit()
    
    async def delete(self, session_id: str) -> bool:
        """–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é"""
        result = await self._db.execute(
            delete(SessionModel).where(SessionModel.id == session_id)
        )
        await self._db.commit()
        return result.rowcount > 0
    
    async def list(self, limit: int = 100, offset: int = 0) -> List[Session]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π"""
        result = await self._db.execute(
            select(SessionModel)
            .limit(limit)
            .offset(offset)
            .order_by(SessionModel.last_activity.desc())
        )
        models = result.scalars().all()
        return [self._mapper.to_entity(m) for m in models]
    
    async def find_active(self, limit: int = 100) -> List[Session]:
        """–ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏"""
        result = await self._db.execute(
            select(SessionModel)
            .where(SessionModel.is_active == True)
            .limit(limit)
            .order_by(SessionModel.last_activity.desc())
        )
        models = result.scalars().all()
        return [self._mapper.to_entity(m) for m in models]
```

#### 4.2. –°–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–µ—Ä –º–µ–∂–¥—É Entity –∏ Model

**`app/infrastructure/persistence/mappers/session_mapper.py`**
```python
from ....domain.entities.session import Session
from ..models.session_model import SessionModel

class SessionMapper:
    """–ú–∞–ø–ø–µ—Ä –º–µ–∂–¥—É –¥–æ–º–µ–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é –∏ –º–æ–¥–µ–ª—å—é –ë–î"""
    
    def to_entity(self, model: SessionModel) -> Session:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –≤ —Å—É—â–Ω–æ—Å—Ç—å"""
        return Session(
            id=model.id,
            title=model.title,
            description=model.description,
            messages=[],  # –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
            last_activity=model.last_activity,
            is_active=model.is_active,
            created_at=model.created_at,
            updated_at=model.updated_at
        )
    
    def to_model(self, entity: Session) -> SessionModel:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å –≤ –º–æ–¥–µ–ª—å"""
        return SessionModel(
            id=entity.id,
            title=entity.title,
            description=entity.description,
            last_activity=entity.last_activity,
            is_active=entity.is_active,
            created_at=entity.created_at,
            updated_at=entity.updated_at
        )
```

### –≠—Ç–∞–ø 5: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API Layer (2-3 –¥–Ω—è)

#### 5.1. –†–∞–∑–¥–µ–ª–∏—Ç—å endpoints.py –Ω–∞ —Ä–æ—É—Ç–µ—Ä—ã

**`app/api/v1/routers/sessions.py`**
```python
from fastapi import APIRouter, Depends, HTTPException
from ....application.commands.create_session import (
    CreateSessionCommand, 
    CreateSessionHandler
)
from ....application.queries.get_session import (
    GetSessionQuery,
    GetSessionHandler
)
from ..schemas.session_schemas import (
    CreateSessionRequest,
    SessionResponse
)
from ..dependencies import get_create_session_handler, get_get_session_handler

router = APIRouter(prefix="/sessions", tags=["sessions"])

@router.post("", response_model=SessionResponse)
async def create_session(
    request: CreateSessionRequest,
    handler: CreateSessionHandler = Depends(get_create_session_handler)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é"""
    command = CreateSessionCommand(session_id=request.session_id)
    session = await handler.handle(command)
    return SessionResponse.from_entity(session)

@router.get("/{session_id}", response_model=SessionResponse)
async def get_session(
    session_id: str,
    handler: GetSessionHandler = Depends(get_get_session_handler)
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ ID"""
    query = GetSessionQuery(session_id=session_id)
    session_dto = await handler.handle(query)
    
    if not session_dto:
        raise HTTPException(status_code=404, detail="Session not found")
    
    return SessionResponse.from_dto(session_dto)
```

**`app/api/v1/routers/messages.py`**
```python
from fastapi import APIRouter, Depends
from sse_starlette.sse import EventSourceResponse
from ....application.commands.add_message import (
    AddMessageCommand,
    AddMessageHandler
)
from ..schemas.message_schemas import MessageRequest
from ..dependencies import get_add_message_handler

router = APIRouter(prefix="/messages", tags=["messages"])

@router.post("/stream")
async def stream_message(
    request: MessageRequest,
    handler: AddMessageHandler = Depends(get_add_message_handler)
):
    """–°—Ç—Ä–∏–º–∏–Ω–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    async def event_generator():
        # –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
        yield {"event": "message", "data": "..."}
    
    return EventSourceResponse(event_generator())
```

#### 5.2. –°–æ–∑–¥–∞—Ç—å API —Å—Ö–µ–º—ã

**`app/api/v1/schemas/session_schemas.py`**
```python
from typing import Optional
from datetime import datetime
from pydantic import BaseModel

class CreateSessionRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    session_id: str
    system_prompt: Optional[str] = None

class SessionResponse(BaseModel):
    """–û—Ç–≤–µ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Å—Å–∏–∏"""
    id: str
    title: Optional[str]
    message_count: int
    last_activity: datetime
    is_active: bool
    
    @classmethod
    def from_dto(cls, dto):
        return cls(**dto.dict())
```

### –≠—Ç–∞–ø 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ (2-3 –¥–Ω—è)

#### 6.1. Session-level locks

**`app/infrastructure/concurrency/session_lock.py`**
```python
import asyncio
from typing import Dict
from contextlib import asynccontextmanager

class SessionLockManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–π"""
    
    def __init__(self):
        self._locks: Dict[str, asyncio.Lock] = {}
        self._global_lock = asyncio.Lock()
    
    @asynccontextmanager
    async def lock(self, session_id: str):
        """–ü–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è —Å–µ—Å—Å–∏–∏"""
        async with self._global_lock:
            if session_id not in self._locks:
                self._locks[session_id] = asyncio.Lock()
            lock = self._locks[session_id]
        
        async with lock:
            yield
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```python
# –í orchestrator
async with self._lock_manager.lock(session_id):
    context = await async_ctx_mgr.get_or_create(session_id)
    # –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
```

#### 6.2. Rate Limiting

**`app/api/middleware/rate_limit.py`**
```python
from fastapi import Request, HTTPException
from starlette.middleware.base import BaseHTTPMiddleware
import time
from collections import defaultdict

class RateLimitMiddleware(BaseHTTPMiddleware):
    """Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def __init__(self, app, requests_per_minute: int = 60):
        super().__init__(app)
        self.requests_per_minute = requests_per_minute
        self.requests = defaultdict(list)
    
    async def dispatch(self, request: Request, call_next):
        client_id = request.client.host
        now = time.time()
        
        # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        self.requests[client_id] = [
            req_time for req_time in self.requests[client_id]
            if now - req_time < 60
        ]
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
        if len(self.requests[client_id]) >= self.requests_per_minute:
            raise HTTPException(
                status_code=429,
                detail="Too many requests"
            )
        
        self.requests[client_id].append(now)
        return await call_next(request)
```

#### 6.3. Circuit Breaker

**`app/infrastructure/resilience/circuit_breaker.py`**
```python
import asyncio
from enum import Enum
from datetime import datetime, timedelta

class CircuitState(Enum):
    CLOSED = "closed"
    OPEN = "open"
    HALF_OPEN = "half_open"

class CircuitBreaker:
    """Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤"""
    
    def __init__(
        self,
        failure_threshold: int = 5,
        recovery_timeout: int = 60,
        expected_exception: type = Exception
    ):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.expected_exception = expected_exception
        
        self.failure_count = 0
        self.last_failure_time = None
        self.state = CircuitState.CLOSED
    
    async def call(self, func, *args, **kwargs):
        """–í—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ circuit breaker"""
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
            else:
                raise Exception("Circuit breaker is OPEN")
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except self.expected_exception as e:
            self._on_failure()
            raise
    
    def _on_success(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤"""
        self.failure_count = 0
        self.state = CircuitState.CLOSED
    
    def _on_failure(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–π –≤—ã–∑–æ–≤"""
        self.failure_count += 1
        self.last_failure_time = datetime.utcnow()
        
        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN
    
    def _should_attempt_reset(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–±—Ä–æ—Å–∏—Ç—å"""
        return (
            self.last_failure_time and
            datetime.utcnow() - self.last_failure_time > 
            timedelta(seconds=self.recovery_timeout)
        )
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```python
# –í LLM client
circuit_breaker = CircuitBreaker(failure_threshold=5, recovery_timeout=60)

async def call_llm_with_protection(*args, **kwargs):
    return await circuit_breaker.call(call_llm, *args, **kwargs)
```

### –≠—Ç–∞–ø 7: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ (2-3 –¥–Ω—è)

#### 7.1. –£–¥–∞–ª–∏—Ç—å deprecated –∫–æ–¥

```python
# –£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å Database –∏–∑ database.py (—Å—Ç—Ä–æ–∫–∏ 878-1094)
# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DatabaseService
```

#### 7.2. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –ø–∞–º—è—Ç–∏

**`app/infrastructure/cleanup/session_cleanup.py`**
```python
import asyncio
import logging
from datetime import datetime, timedelta

logger = logging.getLogger(__name__)

class SessionCleanupService:
    """–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π"""
    
    def __init__(
        self,
        session_repository,
        cleanup_interval_hours: int = 1,
        max_age_hours: int = 24
    ):
        self._repository = session_repository
        self._cleanup_interval = cleanup_interval_hours
        self._max_age = max_age_hours
        self._task = None
    
    async def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –æ—á–∏—Å—Ç–∫—É"""
        self._task = asyncio.create_task(self._cleanup_loop())
        logger.info("Session cleanup service started")
    
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –æ—á–∏—Å—Ç–∫—É"""
        if self._task:
            self._task.cancel()
            try:
                await self._task
            except asyncio.CancelledError:
                pass
        logger.info("Session cleanup service stopped")
    
    async def _cleanup_loop(self):
        """–¶–∏–∫–ª –æ—á–∏—Å—Ç–∫–∏"""
        while True:
            try:
                await asyncio.sleep(self._cleanup_interval * 3600)
                count = await self._repository.cleanup_old(self._max_age)
                logger.info(f"Cleaned up {count} old sessions")
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"Error in cleanup loop: {e}", exc_info=True)
```

#### 7.3. –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é

**`app/application/queries/list_sessions.py`**
```python
from dataclasses import dataclass
from typing import List
from ...domain.repositories.session_repository import SessionRepository
from ..dto.session_dto import SessionDTO

@dataclass
class ListSessionsQuery:
    """–ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π"""
    limit: int = 100
    offset: int = 0

class ListSessionsHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π"""
    
    def __init__(self, repository: SessionRepository):
        self._repository = repository
    
    async def handle(self, query: ListSessionsQuery) -> List[SessionDTO]:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å"""
        sessions = await self._repository.list(
            limit=query.limit,
            offset=query.offset
        )
        return [SessionDTO.from_entity(s) for s in sessions]
```

---

## üìä –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### –ü–æ–¥—Ö–æ–¥: Strangler Fig Pattern

1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** —Å–æ —Å—Ç–∞—Ä–æ–π
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
3. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä—ã
4. **–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥** –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä –∞–¥–∞–ø—Ç–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:

**`app/adapters/legacy_session_manager.py`**
```python
from ..infrastructure.persistence.repositories.session_repository_impl import SessionRepositoryImpl
from ..domain.services.session_management import SessionManagementService

class LegacySessionManagerAdapter:
    """–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ SessionManager"""
    
    def __init__(self, repository: SessionRepositoryImpl):
        self._service = SessionManagementService(repository)
    
    async def get_or_create(self, session_id: str):
        """–°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ get_or_create"""
        try:
            return await self._service.get_session(session_id)
        except SessionNotFoundError:
            return await self._service.create_session(session_id)
    
    # –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏...
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–û–ë–ù–û–í–õ–ï–ù)

### ‚úÖ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ - –ó–ê–í–ï–†–®–ï–ù
- [x] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- [x] –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã
- [x] –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- [x] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤

### ‚úÖ –≠—Ç–∞–ø 2: Domain Layer - –ó–ê–í–ï–†–®–ï–ù
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (Session, AgentContext, Message)
- [x] –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–≤–∫–ª—é—á–∞—è MessageOrchestrationService - 753 —Å—Ç—Ä–æ–∫–∏)
- [x] –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è domain layer

### ‚úÖ –≠—Ç–∞–ø 3: Application Layer - –ó–ê–í–ï–†–®–ï–ù
- [x] –°–æ–∑–¥–∞—Ç—å Command handlers
- [x] –°–æ–∑–¥–∞—Ç—å Query handlers
- [x] –°–æ–∑–¥–∞—Ç—å DTO
- [x] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è application layer

### ‚úÖ –≠—Ç–∞–ø 4: Infrastructure Layer - –ó–ê–í–ï–†–®–ï–ù
- [x] –°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- [x] –°–æ–∑–¥–∞—Ç—å mappers
- [x] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å database.py (—á–∞—Å—Ç–∏—á–Ω–æ - –Ω–æ–≤—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç)
- [x] –ù–∞–ø–∏—Å–∞—Ç—å integration —Ç–µ—Å—Ç—ã

### ‚úÖ –≠—Ç–∞–ø 5: API Layer - –ó–ê–í–ï–†–®–ï–ù
- [x] –†–∞–∑–¥–µ–ª–∏—Ç—å endpoints.py –Ω–∞ —Ä–æ—É—Ç–µ—Ä—ã (5 —Ä–æ—É—Ç–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω—ã)
- [x] –°–æ–∑–¥–∞—Ç—å API —Å—Ö–µ–º—ã
- [x] –û–±–Ω–æ–≤–∏—Ç—å dependencies
- [x] –ù–∞–ø–∏—Å–∞—Ç—å API —Ç–µ—Å—Ç—ã

### ‚úÖ –≠—Ç–∞–ø 6: –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã - –ó–ê–í–ï–†–®–ï–ù
- [x] –î–æ–±–∞–≤–∏—Ç—å session-level locks (SessionLockManager)
- [x] –î–æ–±–∞–≤–∏—Ç—å rate limiting (RateLimitMiddleware)
- [x] –î–æ–±–∞–≤–∏—Ç—å circuit breaker (CircuitBreaker –¥–ª—è LLM)
- [x] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤

### ‚è≥ –≠—Ç–∞–ø 7: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è - –ß–ê–°–¢–ò–ß–ù–û
- [ ] –£–¥–∞–ª–∏—Ç—å deprecated –∫–æ–¥ (Database –∫–ª–∞—Å—Å, —Å—Ç–∞—Ä—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
- [x] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É (SessionCleanupService)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã (N+1 –ø—Ä–æ–±–ª–µ–º—ã)

### ‚è≥ –≠—Ç–∞–ø 8: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è - –í –ü–†–û–¶–ï–°–°–ï
- [x] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç)
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ code review
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (18.01.2026):
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~500 —Å—Ç—Ä–æ–∫
- Cyclomatic Complexity: 8-12
- Test Coverage: ~60%
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: –°—Ä–µ–¥–Ω–∏–π
- –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (20.01.2026):
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~150 —Å—Ç—Ä–æ–∫ ‚úÖ
- Cyclomatic Complexity: 5-8 ‚ö†Ô∏è (—É–ª—É—á—à–µ–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ)
- Test Coverage: ~70% ‚ö†Ô∏è (—É–ª—É—á—à–µ–Ω–æ, —Ü–µ–ª—å 80%)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: –°—Ä–µ–¥–Ω–∏–π ‚ö†Ô∏è (–∏–∑-–∑–∞ —Å–æ—Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ/–Ω–æ–≤–æ–≥–æ)
- –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã: 100% —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã ‚úÖ
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: Clean Architecture ‚úÖ

### –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è deprecated):
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: <150 —Å—Ç—Ä–æ–∫
- Cyclomatic Complexity: 3-5
- Test Coverage: >80%
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: –ù–∏–∑–∫–∏–π

---

## ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (–û–ë–ù–û–í–õ–ï–ù–û)

| –≠—Ç–∞–ø | –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ | –°—Ç–∞—Ç—É—Å |
|------|---------------|------------|--------|
| –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | 1-2 –¥–Ω—è | 1 –¥–µ–Ω—å | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 2: Domain Layer | 3-4 –¥–Ω—è | 3 –¥–Ω—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 3: Application Layer | 2-3 –¥–Ω—è | 2 –¥–Ω—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 4: Infrastructure Layer | 3-4 –¥–Ω—è | 3 –¥–Ω—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 5: API Layer | 2-3 –¥–Ω—è | 2 –¥–Ω—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 6: –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã | 2-3 –¥–Ω—è | 2 –¥–Ω—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω |
| –≠—Ç–∞–ø 7: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | 2-3 –¥–Ω—è | - | ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
| –≠—Ç–∞–ø 8: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è | 2-3 –¥–Ω—è | - | ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
| **–ò–¢–û–ì–û** | **17-25 –¥–Ω–µ–π** | **13 –¥–Ω–µ–π** | **75% –≥–æ—Ç–æ–≤–æ** |

**–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è:** 3-5 –¥–Ω–µ–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - Clean Architecture —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ–µ–≤
2. ‚úÖ **–õ—É—á—à–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - Domain/Application/Infrastructure —Ä–∞–∑–¥–µ–ª–µ–Ω—ã
3. ‚úÖ **–ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤** - –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
4. ‚ö†Ô∏è **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ß–∞—Å—Ç–∏—á–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL)
5. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
6. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç race conditions** - SessionLockManager
7. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç memory leaks** - SessionCleanupService
8. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç DDoS** - RateLimitMiddleware
9. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç cascading failures** - CircuitBreaker
10. ‚úÖ **Event-driven observability** - –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –∏ –∞—É–¥–∏—Ç–∞

---

**–ê–≤—Ç–æ—Ä:** AI Assistant
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 18 —è–Ω–≤–∞—Ä—è 2026
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 20 —è–Ω–≤–∞—Ä—è 2026
**–í–µ—Ä—Å–∏—è:** 2.0 (–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

**Domain Layer:**
- 4 Entity –∫–ª–∞—Å—Å–∞
- 3 Repository –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- 3 Domain Services (–≤–∫–ª—é—á–∞—è MessageOrchestrationService - 753 —Å—Ç—Ä–æ–∫–∏)
- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Domain Events

**Application Layer:**
- 3 Command handlers
- 3 Query handlers
- 3 DTO –∫–ª–∞—Å—Å–æ–≤

**Infrastructure Layer:**
- 2 Repository —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- 2 Mapper –∫–ª–∞—Å—Å–∞
- SessionLockManager (142 —Å—Ç—Ä–æ–∫–∏)
- CircuitBreaker (210 —Å—Ç—Ä–æ–∫)
- RetryHandler
- SessionCleanupService
- 3 Adapter –∫–ª–∞—Å—Å–∞

**API Layer:**
- 5 –Ω–æ–≤—ã—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è messages_router - 311 —Å—Ç—Ä–æ–∫)
- –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä Pydantic —Å—Ö–µ–º
- RateLimitMiddleware

**–ò—Ç–æ–≥–æ:** ~5,000 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ main.py
- ‚úÖ –ê–¥–∞–ø—Ç–µ—Ä—ã —Å–≤—è–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π –∫–æ–¥
- ‚úÖ –ù–æ–≤—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∞–∫—Ç–∏–≤–Ω—ã
- ‚ö†Ô∏è –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Å–æ—Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –Ω–æ–≤—ã–º (~15% overhead)

**–°–º. —Ç–∞–∫–∂–µ:**
- [AGENT_RUNTIME_IMPLEMENTATION_STATUS.md](../../../AGENT_RUNTIME_IMPLEMENTATION_STATUS.md) - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- [FULL_MIGRATION_PLAN_UPDATED.md](FULL_MIGRATION_PLAN_UPDATED.md) - –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏
