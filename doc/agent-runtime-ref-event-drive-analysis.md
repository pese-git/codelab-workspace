# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Agent Runtime –Ω–∞ –≤–µ—Ç–∫–µ ref/event-drive

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 27 —è–Ω–≤–∞—Ä—è 2026  
**–í–µ—Ç–∫–∞:** ref/event-drive  
**–í–µ—Ä—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞:** 0.3.0  
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–ø—Ä–∏–Ω—Ü–∏–ø—ã)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π (Domain Layer)](#–¥–æ–º–µ–Ω–Ω—ã–π-—Å–ª–æ–π-domain-layer)
5. [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π (Infrastructure Layer)](#–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π-—Å–ª–æ–π-infrastructure-layer)
6. [–ü—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–ª–æ–π (Application Layer)](#–ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π-—Å–ª–æ–π-application-layer)
7. [–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Presentation Layer)](#—Å–ª–æ–π-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è-presentation-layer)
8. [Event-Driven Architecture](#event-driven-architecture)
9. [–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞](#–º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è-—Å–∏—Å—Ç–µ–º–∞)
10. [–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#–ø–∞—Ç—Ç–µ—Ä–Ω—ã-–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
11. [–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏](#–∫–ª—é—á–µ–≤—ã–µ-–æ—Ç–ª–∏—á–∏—è-–∏-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
12. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
13. [–í—ã–≤–æ–¥—ã](#–≤—ã–≤–æ–¥—ã)

---

## –û–±–∑–æ—Ä

Agent Runtime Service –Ω–∞ –≤–µ—Ç–∫–µ `ref/event-drive` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ Clean Architecture. –≠—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ FastAPI, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π streaming, HITL (Human-in-the-Loop) –∏ event-driven –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Clean Architecture + DDD + Event-Driven
- **–ü–∞—Ç—Ç–µ—Ä–Ω—ã:** Repository, CQRS, Event Sourcing (—á–∞—Å—Ç–∏—á–Ω–æ), Adapter, Strategy
- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** PostgreSQL/SQLite —Å async SQLAlchemy
- **–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è:** Event Bus –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- **–ê–≥–µ–Ω—Ç—ã:** 5 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ + Orchestrator
- **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** 9 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å HITL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. Clean Architecture

–ü—Ä–æ–µ–∫—Ç —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Clean Architecture —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Presentation Layer                      ‚îÇ
‚îÇ              (API Routes, Middleware)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Application Layer                       ‚îÇ
‚îÇ           (Commands, Queries, Handlers, DTOs)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Domain Layer                          ‚îÇ
‚îÇ    (Entities, Services, Repositories, Events)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Infrastructure Layer                      ‚îÇ
‚îÇ  (Persistence, Adapters, External Services, LLM)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–Ω—É—Ç—Ä—å (–∫ –¥–æ–º–µ–Ω–Ω–æ–º—É —Å–ª–æ—é)
- –î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (Repository pattern)
- –ò–∑–æ–ª—è—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π

### 2. Domain-Driven Design (DDD)

**–î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (Entities):**
- [`Session`](../codelab-ai-service/agent-runtime/app/domain/entities/session.py) - –°–µ—Å—Å–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- [`Message`](../codelab-ai-service/agent-runtime/app/domain/entities/message.py) - –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ
- [`AgentContext`](../codelab-ai-service/agent-runtime/app/domain/entities/agent_context.py) - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞
- [`AgentSwitch`](../codelab-ai-service/agent-runtime/app/domain/entities/agent_context.py) - –ó–∞–ø–∏—Å—å –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞
- [`Approval`](../codelab-ai-service/agent-runtime/app/domain/entities/approval.py) - –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ (HITL)

**–î–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- [`SessionManagementService`](../codelab-ai-service/agent-runtime/app/domain/services/session_management.py) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
- [`AgentOrchestrationService`](../codelab-ai-service/agent-runtime/app/domain/services/agent_orchestration.py) - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- [`MessageOrchestrationService`](../codelab-ai-service/agent-runtime/app/domain/services/message_orchestration.py) - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- [`ApprovalManagementService`](../codelab-ai-service/agent-runtime/app/domain/services/approval_management.py) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è–º–∏

**–î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- `SessionCreated`, `MessageReceived`, `SessionDeactivated`
- `AgentAssigned`, `AgentSwitched`, `TaskCompleted`
- `ApprovalRequested`, `ApprovalGranted`, `ApprovalRejected`

### 3. Event-Driven Architecture

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —à–∏–Ω–æ–π —Å–æ–±—ã—Ç–∏–π:

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- [`EventBus`](../codelab-ai-service/agent-runtime/app/events/event_bus.py) - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π (pub/sub)
- [`BaseEvent`](../codelab-ai-service/agent-runtime/app/events/base_event.py) - –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- [`EventType`](../codelab-ai-service/agent-runtime/app/events/event_types.py) - –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: MetricsCollector, AuditLogger, AgentContextSubscriber

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- Wildcard –ø–æ–¥–ø–∏—Å–∫–∏ (–≤—Å–µ —Å–æ–±—ã—Ç–∏—è)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- Correlation ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- Async –æ–±—Ä–∞–±–æ—Ç–∫–∞ (fire-and-forget –∏–ª–∏ wait-for-handlers)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
app/
‚îú‚îÄ‚îÄ main.py                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI
‚îú‚îÄ‚îÄ core/                            # –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ config.py                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py             # Dependency Injection
‚îÇ   ‚îî‚îÄ‚îÄ errors/                     # –î–æ–º–µ–Ω–Ω—ã–µ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
‚îÇ       ‚îú‚îÄ‚îÄ base.py
‚îÇ       ‚îú‚îÄ‚îÄ domain_errors.py
‚îÇ       ‚îî‚îÄ‚îÄ infrastructure_errors.py
‚îÇ
‚îú‚îÄ‚îÄ domain/                          # –î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π (DDD)
‚îÇ   ‚îú‚îÄ‚îÄ entities/                   # –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                # –ë–∞–∑–æ–≤–∞—è —Å—É—â–Ω–æ—Å—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py             # –°–µ—Å—Å–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message.py             # –°–æ–æ–±—â–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_context.py       # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ approval.py            # –û–¥–æ–±—Ä–µ–Ω–∏–µ (HITL)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hitl.py                # HITL —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ repositories/               # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                # –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_repository.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_context_repository.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ approval_repository.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                   # –î–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_management.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_orchestration.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ message_orchestration.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ approval_management.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hitl_management.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_registry.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tool_registry.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ events/                     # –î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ base.py
‚îÇ       ‚îú‚îÄ‚îÄ session_events.py
‚îÇ       ‚îú‚îÄ‚îÄ agent_events.py
‚îÇ       ‚îî‚îÄ‚îÄ approval_events.py
‚îÇ
‚îú‚îÄ‚îÄ application/                     # –ü—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–ª–æ–π (CQRS)
‚îÇ   ‚îú‚îÄ‚îÄ commands/                   # –ö–æ–º–∞–Ω–¥—ã (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_session.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add_message.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ switch_agent.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ queries/                    # –ó–∞–ø—Ä–æ—Å—ã (—á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_session.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list_sessions.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get_agent_context.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ dto/                        # Data Transfer Objects
‚îÇ       ‚îú‚îÄ‚îÄ session_dto.py
‚îÇ       ‚îú‚îÄ‚îÄ message_dto.py
‚îÇ       ‚îî‚îÄ‚îÄ agent_context_dto.py
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/                  # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ persistence/                # –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/                # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_context.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hitl.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mappers/               # –ú–∞–ø–ø–∏–Ω–≥ Entity ‚Üî Model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_mapper.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ agent_context_mapper.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/          # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ session_repository_impl.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ agent_context_repository_impl.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ approval_repository_impl.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ adapters/                   # –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_manager_adapter.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_context_manager_adapter.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event_publisher_adapter.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ llm/                        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ streaming.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tool_parser.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ concurrency/                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session_lock.py        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–µ—Å—Å–∏–π
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ cleanup/                    # –°–µ—Ä–≤–∏—Å—ã –æ—á–∏—Å—Ç–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session_cleanup.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ resilience/                 # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
‚îÇ       ‚îú‚îÄ‚îÄ circuit_breaker.py
‚îÇ       ‚îî‚îÄ‚îÄ retry_handler.py
‚îÇ
‚îú‚îÄ‚îÄ events/                          # Event-Driven Architecture
‚îÇ   ‚îú‚îÄ‚îÄ event_bus.py                # –®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ base_event.py               # –ë–∞–∑–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ event_types.py              # –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ agent_events.py             # –°–æ–±—ã—Ç–∏—è –∞–≥–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ session_events.py           # –°–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ tool_events.py              # –°–æ–±—ã—Ç–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ llm_events.py               # –°–æ–±—ã—Ç–∏—è LLM
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ subscribers/                # –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
‚îÇ       ‚îú‚îÄ‚îÄ metrics_collector.py
‚îÇ       ‚îú‚îÄ‚îÄ audit_logger.py
‚îÇ       ‚îú‚îÄ‚îÄ agent_context_subscriber.py
‚îÇ       ‚îî‚îÄ‚îÄ session_metrics_collector.py
‚îÇ
‚îú‚îÄ‚îÄ agents/                          # –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îú‚îÄ‚îÄ base_agent.py               # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator_agent.py       # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ coder_agent.py              # –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ architect_agent.py          # –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ debug_agent.py              # –û—Ç–ª–∞–¥—á–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ ask_agent.py                # –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ universal_agent.py          # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ prompts/                    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.py
‚îÇ       ‚îú‚îÄ‚îÄ coder.py
‚îÇ       ‚îú‚îÄ‚îÄ architect.py
‚îÇ       ‚îú‚îÄ‚îÄ debug.py
‚îÇ       ‚îî‚îÄ‚îÄ ask.py
‚îÇ
‚îú‚îÄ‚îÄ api/                             # –°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (API)
‚îÇ   ‚îú‚îÄ‚îÄ middleware/                 # Middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ internal_auth.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rate_limit.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ v1/                         # API v1
‚îÇ       ‚îú‚îÄ‚îÄ routers/                # –†–æ—É—Ç–µ—Ä—ã
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ health_router.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sessions_router.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ agents_router.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ messages_router.py
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ events_router.py
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ schemas/                # Pydantic —Å—Ö–µ–º—ã –¥–ª—è API
‚îÇ           ‚îú‚îÄ‚îÄ session_schemas.py
‚îÇ           ‚îú‚îÄ‚îÄ agent_schemas.py
‚îÇ           ‚îú‚îÄ‚îÄ message_schemas.py
‚îÇ           ‚îî‚îÄ‚îÄ health_schemas.py
‚îÇ
‚îî‚îÄ‚îÄ models/                          # –û–±—â–∏–µ –º–æ–¥–µ–ª–∏
    ‚îú‚îÄ‚îÄ schemas.py                  # StreamChunk –∏ –¥—Ä.
    ‚îî‚îÄ‚îÄ hitl_models.py              # HITL –º–æ–¥–µ–ª–∏
```

---

## –î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π (Domain Layer)

### –°—É—â–Ω–æ—Å—Ç–∏ (Entities)

#### 1. Session (–°–µ—Å—Å–∏—è)

**–§–∞–π–ª:** [`app/domain/entities/session.py`](../codelab-ai-service/agent-runtime/app/domain/entities/session.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–ª–∏–º–∏—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `add_message(message)` - –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `get_recent_messages(limit)` - –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
- `get_history_for_llm()` - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è LLM API
- `deactivate(reason)` - –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é
- `clear_messages()` - –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –ú–∞–∫—Å–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ—Å—Å–∏—é
- –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_activity` –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏

#### 2. Message (–°–æ–æ–±—â–µ–Ω–∏–µ)

**–§–∞–π–ª:** [`app/domain/entities/message.py`](../codelab-ai-service/agent-runtime/app/domain/entities/message.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–æ–ª–µ–π (user, assistant, system, tool)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ tool calls –∏ tool results

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `to_llm_format()` - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç LLM API
- `from_llm_format(data)` - –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ LLM API
- `is_user_message()`, `is_assistant_message()`, `is_tool_message()`
- `has_tool_calls()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- Content –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è user, system, tool —Å–æ–æ–±—â–µ–Ω–∏–π
- Content –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è assistant —Å tool_calls
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ tool_call_id –¥–ª—è —Å–≤—è–∑–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

#### 3. AgentContext (–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≥–µ–Ω—Ç–∞)

**–§–∞–π–ª:** [`app/domain/entities/agent_context.py`](../codelab-ai-service/agent-runtime/app/domain/entities/agent_context.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `switch_to(target_agent, reason)` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `can_switch_to(target_agent)` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- `get_switch_history()` - –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
- `reset_to_orchestrator()` - –°–±—Ä–æ—Å –∫ Orchestrator

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:**
- –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ç–æ–≥–æ –∂–µ –∞–≥–µ–Ω—Ç–∞
- –ú–∞–∫—Å–∏–º—É–º 50 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤)
- –ö–∞–∂–¥–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ confidence level –¥–ª—è LLM-based routing

#### 4. AgentSwitch (–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ó–∞–ø–∏—Å—å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞
- –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–ø—Ä–∏—á–∏–Ω–∞, confidence, –≤—Ä–µ–º—è)

**–ü–æ–ª—è:**
- `from_agent` - –ò—Å—Ö–æ–¥–Ω—ã–π –∞–≥–µ–Ω—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å None –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ)
- `to_agent` - –¶–µ–ª–µ–≤–æ–π –∞–≥–µ–Ω—Ç
- `reason` - –ü—Ä–∏—á–∏–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- `switched_at` - –í—Ä–µ–º—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- `confidence` - –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (low/medium/high)

### –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (Repository Interfaces)

#### –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

**–§–∞–π–ª:** [`app/domain/repositories/base.py`](../codelab-ai-service/agent-runtime/app/domain/repositories/base.py)

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```python
class Repository(ABC, Generic[T]):
    async def get(id: str) -> Optional[T]
    async def save(entity: T) -> None
    async def delete(id: str) -> bool
    async def list(limit: int, offset: int) -> List[T]
    async def exists(id: str) -> bool
    async def count() -> int
```

**–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:**
- `SessionRepository` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Å–µ—Å—Å–∏–π
  - `find_by_id(session_id)` - –ü–æ–∏—Å–∫ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π
  - `find_active(limit, offset)` - –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
  - `cleanup_old(max_age_hours)` - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π
  
- `AgentContextRepository` - –ú–µ—Ç–æ–¥—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
  - `find_by_session_id(session_id)` - –ü–æ–∏—Å–∫ –ø–æ —Å–µ—Å—Å–∏–∏
  - `get_agent_usage_stats()` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤

- `ApprovalRepository` - –ú–µ—Ç–æ–¥—ã –¥–ª—è HITL –æ–¥–æ–±—Ä–µ–Ω–∏–π
  - `find_pending_by_session(session_id)` - Pending –æ–¥–æ–±—Ä–µ–Ω–∏—è
  - `find_by_request_id(request_id)` - –ü–æ–∏—Å–∫ –ø–æ ID –∑–∞–ø—Ä–æ—Å–∞

### –î–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### 1. SessionManagementService

**–§–∞–π–ª:** [`app/domain/services/session_management.py`](../codelab-ai-service/agent-runtime/app/domain/services/session_management.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Å–µ—Å—Å–∏—è–º–∏
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def create_session(session_id: Optional[str]) -> Session
async def get_session(session_id: str) -> Session
async def get_or_create_session(session_id: str) -> Session
async def add_message(session_id, role, content, ...) -> Message
async def add_tool_result(session_id, call_id, result, error) -> Message
async def deactivate_session(session_id, reason) -> Session
async def list_active_sessions(limit, offset) -> List[Session]
async def cleanup_old_sessions(max_age_hours) -> int
```

**–°–æ–±—ã—Ç–∏—è:**
- `SessionCreated` - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
- `MessageReceived` - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- `SessionDeactivated` - –ü—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏

#### 2. AgentOrchestrationService

**–§–∞–π–ª:** [`app/domain/services/agent_orchestration.py`](../codelab-ai-service/agent-runtime/app/domain/services/agent_orchestration.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∞–≥–µ–Ω—Ç–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def get_or_create_context(session_id, initial_agent) -> AgentContext
async def switch_agent(session_id, target_agent, reason, confidence) -> AgentContext
async def get_current_agent(session_id) -> Optional[AgentType]
async def get_agent_usage_stats() -> dict
```

**–°–æ–±—ã—Ç–∏—è:**
- `AgentAssigned` - –ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞
- `AgentSwitchRequested` - –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- `AgentSwitched` - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏

#### 3. MessageOrchestrationService

**–§–∞–π–ª:** [`app/domain/services/message_orchestration.py`](../codelab-ai-service/agent-runtime/app/domain/services/message_orchestration.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ streaming –æ—Ç–≤–µ—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∞–≥–µ–Ω—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ tool results –∏ HITL —Ä–µ—à–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def process_message(session_id, message, agent_type) -> AsyncGenerator[StreamChunk]
async def process_tool_result(session_id, call_id, result, error) -> AsyncGenerator[StreamChunk]
async def process_hitl_decision(session_id, call_id, decision, ...) -> AsyncGenerator[StreamChunk]
async def switch_agent(session_id, agent_type, reason) -> AsyncGenerator[StreamChunk]
async def get_current_agent(session_id) -> Optional[AgentType]
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `SessionLockManager` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ Orchestrator
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç switch_agent chunks –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤
- –î–æ–±–∞–≤–ª—è–µ—Ç tool_result –¥–ª—è switch_mode –≤ –∏—Å—Ç–æ—Ä–∏—é

---

## –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π (Infrastructure Layer)

### –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Persistence)

#### SQLAlchemy –º–æ–¥–µ–ª–∏

**–§–∞–π–ª:** [`app/infrastructure/persistence/models/`](../codelab-ai-service/agent-runtime/app/infrastructure/persistence/models/)

**–ú–æ–¥–µ–ª–∏:**
- `SessionModel` - –¢–∞–±–ª–∏—Ü–∞ sessions
- `MessageModel` - –¢–∞–±–ª–∏—Ü–∞ messages (—Å–≤—è–∑—å —Å SessionModel)
- `AgentContextModel` - –¢–∞–±–ª–∏—Ü–∞ agent_contexts
- `AgentSwitchModel` - –¢–∞–±–ª–∏—Ü–∞ agent_switches
- `ApprovalModel` - –¢–∞–±–ª–∏—Ü–∞ approvals (HITL)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Async SQLAlchemy (asyncpg –¥–ª—è PostgreSQL, aiosqlite –¥–ª—è SQLite)
- Soft delete (deleted_at –ø–æ–ª–µ)
- Timestamps (created_at, updated_at)
- Relationships —Å lazy loading

#### Mappers (–ú–∞–ø–ø–∏–Ω–≥ Entity ‚Üî Model)

**–§–∞–π–ª:** [`app/infrastructure/persistence/mappers/`](../codelab-ai-service/agent-runtime/app/infrastructure/persistence/mappers/)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ –º–æ–¥–µ–ª–∏ –ë–î –∏ –æ–±—Ä–∞—Ç–Ω–æ
- –ò–∑–æ–ª—è—Ü–∏—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—è –æ—Ç –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
class SessionMapper:
    async def to_entity(model: SessionModel, db: AsyncSession, load_messages: bool) -> Session
    async def to_model(entity: Session, db: AsyncSession) -> SessionModel
```

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

**–§–∞–π–ª:** [`app/infrastructure/persistence/repositories/session_repository_impl.py`](../codelab-ai-service/agent-runtime/app/infrastructure/persistence/repositories/session_repository_impl.py)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏–∑ –¥–æ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ mappers –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (lazy loading, batch operations)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –≤ –¥–æ–º–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```python
class SessionRepositoryImpl(SessionRepository):
    def __init__(self, db: AsyncSession):
        self._db = db
        self._mapper = SessionMapper()
    
    async def find_by_id(self, session_id: str) -> Optional[Session]:
        # –ü–æ–ª—É—á–∏—Ç—å –º–æ–¥–µ–ª—å –∏–∑ –ë–î
        result = await self._db.execute(
            select(SessionModel).where(SessionModel.id == session_id)
        )
        model = result.scalar_one_or_none()
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Å—É—â–Ω–æ—Å—Ç—å
        return await self._mapper.to_entity(model, self._db, load_messages=True)
```

### –ê–¥–∞–ø—Ç–µ—Ä—ã (Adapters)

**–§–∞–π–ª:** [`app/infrastructure/adapters/`](../codelab-ai-service/agent-runtime/app/infrastructure/adapters/)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∫ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

**–ê–¥–∞–ø—Ç–µ—Ä—ã:**
- `SessionManagerAdapter` - –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç SessionManagementService
- `AgentContextManagerAdapter` - –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç AgentOrchestrationService
- `EventPublisherAdapter` - –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç EventBus –¥–ª—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

### LLM Integration

**–§–∞–π–ª:** [`app/infrastructure/llm/`](../codelab-ai-service/agent-runtime/app/infrastructure/llm/)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `LLMClient` - –ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å LLM Proxy
- `LLMStreamService` - –°–µ—Ä–≤–∏—Å –¥–ª—è streaming –æ—Ç–≤–µ—Ç–æ–≤
- `ToolParser` - –ü–∞—Ä—Å–∏–Ω–≥ tool calls –∏–∑ LLM –æ—Ç–≤–µ—Ç–æ–≤

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Async streaming —á–µ—Ä–µ–∑ httpx
- –û–±—Ä–∞–±–æ—Ç–∫–∞ SSE (Server-Sent Events)
- –ü–∞—Ä—Å–∏–Ω–≥ tool calls –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã

### Concurrency (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é)

**–§–∞–π–ª:** [`app/infrastructure/concurrency/session_lock.py`](../codelab-ai-service/agent-runtime/app/infrastructure/concurrency/session_lock.py)

**SessionLockManager:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–π
- Async context manager –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
async with session_lock_manager.lock(session_id):
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏—é
    await process_message(session_id, message)
```

### Resilience (–ü–∞—Ç—Ç–µ—Ä–Ω—ã —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)

**–§–∞–π–ª:** [`app/infrastructure/resilience/`](../codelab-ai-service/agent-runtime/app/infrastructure/resilience/)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `CircuitBreaker` - –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤
- `RetryHandler` - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff

---

## –ü—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–ª–æ–π (Application Layer)

### CQRS Pattern

–°—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è) –∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (—á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö).

#### Commands (–ö–æ–º–∞–Ω–¥—ã)

**–§–∞–π–ª:** [`app/application/commands/`](../codelab-ai-service/agent-runtime/app/application/commands/)

**–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å:**
```python
class Command(BaseModel, ABC):
    class Config:
        frozen = True  # –ù–µ–∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å
```

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
- `CreateSessionCommand` - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `AddMessageCommand` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `SwitchAgentCommand` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞

**Command Handlers:**
```python
class CreateSessionHandler(CommandHandler[Session]):
    def __init__(self, service: SessionManagementService):
        self._service = service
    
    async def handle(self, command: CreateSessionCommand) -> Session:
        return await self._service.create_session(command.session_id)
```

#### Queries (–ó–∞–ø—Ä–æ—Å—ã)

**–§–∞–π–ª:** [`app/application/queries/`](../codelab-ai-service/agent-runtime/app/application/queries/)

**–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å:**
```python
class Query(BaseModel, ABC):
    class Config:
        frozen = True  # –ù–µ–∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å
```

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
- `GetSessionQuery` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `ListSessionsQuery` - –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
- `GetAgentContextQuery` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≥–µ–Ω—Ç–∞

**Query Handlers:**
```python
class GetSessionHandler(QueryHandler[SessionDTO]):
    def __init__(self, repository: SessionRepository):
        self._repository = repository
    
    async def handle(self, query: GetSessionQuery) -> SessionDTO:
        session = await self._repository.find_by_id(query.session_id)
        return SessionDTO.from_entity(session)
```

### DTOs (Data Transfer Objects)

**–§–∞–π–ª:** [`app/application/dto/`](../codelab-ai-service/agent-runtime/app/application/dto/)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
- –ò–∑–æ–ª—è—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö API
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic

**–ü—Ä–∏–º–µ—Ä—ã:**
- `SessionDTO` - DTO –¥–ª—è —Å–µ—Å—Å–∏–∏
- `MessageDTO` - DTO –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
- `AgentContextDTO` - DTO –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≥–µ–Ω—Ç–∞

---

## –°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Presentation Layer)

### API Routers

**–§–∞–π–ª:** [`app/api/v1/routers/`](../codelab-ai-service/agent-runtime/app/api/v1/routers/)

**–†–æ—É—Ç–µ—Ä—ã:**
- `health_router.py` - Health check endpoints
- `sessions_router.py` - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Å—Å–∏—è–º–∏
- `agents_router.py` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≥–µ–Ω—Ç–∞—Ö
- `messages_router.py` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (streaming)
- `events_router.py` - –ú–µ—Ç—Ä–∏–∫–∏ –∏ audit log

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Dependency Injection —á–µ—Ä–µ–∑ FastAPI Depends
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic schemas
- SSE streaming –¥–ª—è real-time –æ—Ç–≤–µ—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ HTTP —Å—Ç–∞—Ç—É—Å–∞–º–∏

### Middleware

**–§–∞–π–ª:** [`app/api/middleware/`](../codelab-ai-service/agent-runtime/app/api/middleware/)

**Middleware:**
- `InternalAuthMiddleware` - –ü—Ä–æ–≤–µ—Ä–∫–∞ X-Internal-Auth –∑–∞–≥–æ–ª–æ–≤–∫–∞
- `RateLimitMiddleware` - Rate limiting (60 req/min)

### API Schemas

**–§–∞–π–ª:** [`app/api/v1/schemas/`](../codelab-ai-service/agent-runtime/app/api/v1/schemas/)

**Pydantic —Å—Ö–µ–º—ã –¥–ª—è API:**
- Request/Response –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ endpoint
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## Event-Driven Architecture

### EventBus (–®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π)

**–§–∞–π–ª:** [`app/events/event_bus.py`](../codelab-ai-service/agent-runtime/app/events/event_bus.py)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **Pub/Sub –ø–∞—Ç—Ç–µ—Ä–Ω** - –ò–∑–¥–∞—Ç–µ–ª–∏ –∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å–ª–∞–±–æ —Å–≤—è–∑–∞–Ω—ã
- **–ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É** - `event_bus.subscribe(event_type=EventType.AGENT_SWITCHED)`
- **–ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** - `event_bus.subscribe(event_category=EventCategory.AGENT)`
- **Wildcard –ø–æ–¥–ø–∏—Å–∫–∏** - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (10 = –≤—ã—Å–æ–∫–∏–π, 0 = –Ω–∏–∑–∫–∏–π)
- **Middleware** - –û–±—Ä–∞–±–æ—Ç–∫–∞/—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç–∞–≤–∫–æ–π
- **Async –æ–±—Ä–∞–±–æ—Ç–∫–∞** - Fire-and-forget –∏–ª–∏ wait-for-handlers
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –ú–µ—Ç—Ä–∏–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
@event_bus.subscribe(event_type=EventType.AGENT_SWITCHED, priority=10)
async def on_agent_switched(event: BaseEvent):
    logger.info(f"Agent switched: {event.data}")

# –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è
await event_bus.publish(
    AgentSwitchedEvent(
        session_id="session-123",
        from_agent="orchestrator",
        to_agent="coder",
        reason="Coding task detected"
    ),
    wait_for_handlers=True
)
```

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

**–§–∞–π–ª:** [`app/events/event_types.py`](../codelab-ai-service/agent-runtime/app/events/event_types.py)

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:**
- `EventCategory.AGENT` - –°–æ–±—ã—Ç–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- `EventCategory.SESSION` - –°–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–π
- `EventCategory.TOOL` - –°–æ–±—ã—Ç–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `EventCategory.HITL` - HITL —Å–æ–±—ã—Ç–∏—è
- `EventCategory.SYSTEM` - –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- `EventCategory.METRICS` - –°–æ–±—ã—Ç–∏—è –º–µ—Ç—Ä–∏–∫

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã:**
- `AGENT_SWITCHED`, `AGENT_PROCESSING_STARTED`, `AGENT_PROCESSING_COMPLETED`
- `SESSION_CREATED`, `MESSAGE_ADDED`, `SESSION_DEACTIVATED`
- `TOOL_EXECUTION_REQUESTED`, `TOOL_APPROVAL_REQUIRED`
- `HITL_DECISION_MADE`
- `SYSTEM_STARTUP`, `SYSTEM_SHUTDOWN`

### –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ (Subscribers)

**–§–∞–π–ª:** [`app/events/subscribers/`](../codelab-ai-service/agent-runtime/app/events/subscribers/)

#### 1. MetricsCollector

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏–∑ —Å–æ–±—ã—Ç–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∞–≥–µ–Ω—Ç–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- HITL —Ä–µ—à–µ–Ω–∏—è

**–°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```python
{
    "agent_switches": {
        "orchestrator_to_coder": 15,
        "coder_to_debug": 3
    },
    "agent_processing": {
        "coder": {
            "count": 20,
            "total_duration_ms": 30000,
            "success_count": 18,
            "failure_count": 2
        }
    },
    "tool_executions": {
        "write_file": {
            "requested": 10,
            "completed": 8,
            "failed": 2
        }
    },
    "hitl_decisions": {
        "write_file": {
            "APPROVE": 7,
            "EDIT": 2,
            "REJECT": 1
        }
    }
}
```

#### 2. AuditLogger

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å–µ—Å—Å–∏–∏ –∏ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è

**–õ–æ–≥–∏—Ä—É–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- HITL —Ä–µ—à–µ–Ω–∏—è
- –û—à–∏–±–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è approval

#### 3. AgentContextSubscriber

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≥–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### 4. SessionMetricsCollector

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Correlation ID –∏ —Ç—Ä–µ–π—Å–∏–Ω–≥

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–µ—Ç `correlation_id` –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- `causation_id` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è debugging

---

## –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤

**–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å:** [`app/agents/base_agent.py`](../codelab-ai-service/agent-runtime/app/agents/base_agent.py)

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```python
class BaseAgent(ABC):
    def __init__(self, agent_type, system_prompt, allowed_tools, file_restrictions):
        pass
    
    @abstractmethod
    async def process(self, session_id, message, context, session, session_service) -> AsyncGenerator:
        pass
    
    def can_use_tool(self, tool_name: str) -> bool
    def can_edit_file(self, file_path: str) -> bool
```

### –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã

#### 1. Orchestrator Agent üé≠

**–§–∞–π–ª:** [`app/agents/orchestrator_agent.py`](../codelab-ai-service/agent-runtime/app/agents/orchestrator_agent.py)

**–†–æ–ª—å:** –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –∑–∞–¥–∞—á

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- LLM-based routing —Å fallback –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
- –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏ –∏ –≤—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞
- –¢–æ–ª—å–∫–æ read-only –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (read_file, list_files, search_in_code)

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** 3 (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)

**–õ–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:**
1. –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ LLM
2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
3. –í—ã–±–æ—Ä –∞–≥–µ–Ω—Ç–∞ —Å confidence level
4. –í–æ–∑–≤—Ä–∞—Ç switch_agent chunk

#### 2. Coder Agent üíª

**–§–∞–π–ª:** [`app/agents/coder_agent.py`](../codelab-ai-service/agent-runtime/app/agents/coder_agent.py)

**–†–æ–ª—å:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–¥–∞

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º (9 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
- –ù–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ diff –ø–∞—Ç—á–µ–π

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** –í—Å–µ 9 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –ù–µ—Ç

#### 3. Architect Agent üèóÔ∏è

**–§–∞–π–ª:** [`app/agents/architect_agent.py`](../codelab-ai-service/agent-runtime/app/agents/architect_agent.py)

**–†–æ–ª—å:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ù–∞–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** read_file, write_file, list_files, search_in_code

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `.md` —Ñ–∞–π–ª—ã

#### 4. Debug Agent üêõ

**–§–∞–π–ª:** [`app/agents/debug_agent.py`](../codelab-ai-service/agent-runtime/app/agents/debug_agent.py)

**–†–æ–ª—å:** –û—Ç–ª–∞–¥—á–∏–∫ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –∏ –ø–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** read_file, list_files, search_in_code, execute_command

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –ë–µ–∑ write_file (read-only –¥–ª—è —Ñ–∞–π–ª–æ–≤)

#### 5. Ask Agent üí¨

**–§–∞–π–ª:** [`app/agents/ask_agent.py`](../codelab-ai-service/agent-runtime/app/agents/ask_agent.py)

**–†–æ–ª—å:** –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –ø–æ–º–æ—â–Ω–∏–∫

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** read_file, search_in_code, list_files

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ

### Agent Registry

**–§–∞–π–ª:** [`app/domain/services/agent_registry.py`](../codelab-ai-service/agent-runtime/app/domain/services/agent_registry.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤
- Singleton –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ –Ω—É–∂–Ω–æ–º—É –∞–≥–µ–Ω—Ç—É

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from app.domain.services.agent_registry import agent_router

# –ü–æ–ª—É—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
coder = agent_router.get_agent(AgentType.CODER)

# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
async for chunk in coder.process(session_id, message, context, session, session_service):
    yield chunk
```

### Tool Registry

**–§–∞–π–ª:** [`app/domain/services/tool_registry.py`](../codelab-ai-service/agent-runtime/app/domain/services/tool_registry.py)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
1. `read_file` - –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
2. `write_file` - –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ (—Ç—Ä–µ–±—É–µ—Ç HITL approval)
3. `list_files` - –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
4. `search_in_code` - –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É (regex)
5. `execute_command` - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (—Ç—Ä–µ–±—É–µ—Ç HITL approval)
6. `apply_diff` - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ diff –ø–∞—Ç—á–∞
7. `ask_followup_question` - –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
8. `attempt_completion` - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
9. `switch_mode` - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞/–∞–≥–µ–Ω—Ç–∞

**HITL (Human-in-the-Loop):**
- –û–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `write_file`, `execute_command` - –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±—É—é—Ç approval
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç: approve, edit, reject
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ feedback –ø—Ä–∏ rejection

---

## –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. Repository Pattern

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤ –¥–æ–º–µ–Ω–Ω–æ–º —Å–ª–æ–µ
- –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–º —Å–ª–æ–µ
- –ò–∑–æ–ª—è—Ü–∏—è –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –æ—Ç –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

### 2. CQRS (Command Query Responsibility Segregation)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- Commands –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- Queries –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–¥–µ–ª—å–Ω—ã–µ handlers –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞

### 3. Event Sourcing (—á–∞—Å—Ç–∏—á–Ω–æ)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –í—Å–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É–±–ª–∏–∫—É—é—Ç —Å–æ–±—ã—Ç–∏—è
- –°–æ–±—ã—Ç–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ audit log
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å replay —Å–æ–±—ã—Ç–∏–π (–≤ –±—É–¥—É—â–µ–º)

### 4. Adapter Pattern

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- SessionManagerAdapter
- AgentContextManagerAdapter
- EventPublisherAdapter

### 5. Strategy Pattern

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –†–∞–∑–ª–∏—á–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –∫–∞–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- AgentRouter –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### 6. Observer Pattern

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- EventBus –∫–∞–∫ Subject
- Subscribers –∫–∞–∫ Observers

### 7. Dependency Injection

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- FastAPI Depends –¥–ª—è DI
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π [`dependencies.py`](../codelab-ai-service/agent-runtime/app/core/dependencies.py)
- Request-scoped –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### 8. Circuit Breaker

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- CircuitBreaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### 9. Retry Pattern

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- RetryHandler —Å exponential backoff
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

---

## –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –ü–æ–ª–Ω–∞—è Clean Architecture

**–û—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
- –°—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 4 —Å–ª–æ—è (Domain, Application, Infrastructure, Presentation)
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–Ω—É—Ç—Ä—å (–∫ –¥–æ–º–µ–Ω–Ω–æ–º—É —Å–ª–æ—é)
- –î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (Repository) –¥–ª—è –∏–Ω–≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–µ–≥–∫–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (mock —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤)
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –∏ –ë–î
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### 2. Event-Driven Architecture

**–û—Ç–ª–∏—á–∏–µ:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π (EventBus)
- –í—Å–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É–±–ª–∏–∫—É—é—Ç —Å–æ–±—ã—Ç–∏—è
- –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫, –∞—É–¥–∏—Ç–∞, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Observability - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ distributed events (Redis Pub/Sub)

### 3. CQRS Pattern

**–û—Ç–ª–∏—á–∏–µ:**
- –°—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ Commands –∏ Queries
- –û—Ç–¥–µ–ª—å–Ω—ã–µ handlers –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 4. Domain-Driven Design

**–û—Ç–ª–∏—á–∏–µ:**
- –ë–æ–≥–∞—Ç—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- –î–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- Ubiquitous Language –≤ –∫–æ–¥–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –õ–µ–≥–∫–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### 5. Async/Await –≤–µ–∑–¥–µ

**–û—Ç–ª–∏—á–∏–µ:**
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥
- Async SQLAlchemy
- Async event handlers
- Async streaming

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 6. Request-scoped Dependencies

**–û—Ç–ª–∏—á–∏–µ:**
- Database session —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit/rollback
- –ò–∑–æ–ª—è—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- Thread-safety

### 7. Mappers –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏

**–û—Ç–ª–∏—á–∏–µ:**
- –û—Ç–¥–µ–ª—å–Ω—ã–µ mappers –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Entity ‚Üî Model
- –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –∑–Ω–∞—é—Ç –æ –ë–î
- SQLAlchemy –º–æ–¥–µ–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –¥–æ–º–µ–Ω–Ω–æ–º —Å–ª–æ–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Å–ª–æ–µ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- –õ–µ–≥–∫–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –¥—Ä—É–≥—É—é –ë–î

### 8. Session Locking

**–û—Ç–ª–∏—á–∏–µ:**
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
- Async context manager –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 9. Correlation ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞

**–û—Ç–ª–∏—á–∏–µ:**
- –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∏–º–µ–µ—Ç correlation_id
- –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π correlation_id
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è debugging

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–µ–≥–∫–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏
- –¢—Ä–µ–π—Å–∏–Ω–≥ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### 10. Resilience Patterns

**–û—Ç–ª–∏—á–∏–µ:**
- Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–±–æ–µ–≤
- Retry —Å exponential backoff
- Graceful degradation

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º
- –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend Framework
- **FastAPI 0.104.1** - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π async web framework
- **Uvicorn 0.24.0** - ASGI —Å–µ—Ä–≤–µ—Ä
- **Pydantic 2.5.1** - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### Database
- **SQLAlchemy 2.0+** - ORM —Å async –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- **asyncpg 0.29.0** - Async PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
- **aiosqlite 0.19.0** - Async SQLite –¥—Ä–∞–π–≤–µ—Ä
- **psycopg2-binary 2.9.9** - PostgreSQL –∞–¥–∞–ø—Ç–µ—Ä

### LLM Integration
- **langchain 0.2.5+** - LLM —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **smolagents 1.23.0+** - Agent framework
- **httpx 0.25.1** - Async HTTP –∫–ª–∏–µ–Ω—Ç

### Event Streaming
- **sse-starlette 1.6.5** - Server-Sent Events –¥–ª—è streaming

### Resilience
- **tenacity 8.2.3** - Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã

### Monitoring
- **structlog 24.1.0** - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **prometheus-client 0.19.0** - –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Prometheus

### Security
- **slowapi 0.1.9** - Rate limiting

### Development
- **pytest 9.0.2** - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **pytest-asyncio 1.3.0** - Async —Ç–µ—Å—Ç—ã
- **pytest-cov 7.0.0** - Coverage
- **ruff 0.14.8** - Linting –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –í—ã–≤–æ–¥—ã

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
   - –õ–µ–≥–∫–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤

2. **Event-Driven –ø–æ–¥—Ö–æ–¥**
   - –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –û—Ç–ª–∏—á–Ω–∞—è observability
   - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

3. **Domain-Driven Design**
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
   - –ë–æ–≥–∞—Ç—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
   - Ubiquitous Language

4. **CQRS Pattern**
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
   - –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞

5. **–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**
   - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
   - –ì–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
   - –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

6. **Resilience Patterns**
   - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º
   - Graceful degradation
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **Event Store**
   - –°–µ–π—á–∞—Å —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ (audit log)
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π –≤ –ë–î
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å replay —Å–æ–±—ã—Ç–∏–π

2. **Distributed Event Bus**
   - –¢–µ–∫—É—â–∏–π EventBus —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
   - –î–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω Redis Pub/Sub
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ distributed tracing

3. **Saga Pattern**
   - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏
   - –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

4. **Caching Layer**
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - Redis –¥–ª—è distributed cache
   - Cache invalidation —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

5. **API Versioning**
   - –°–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ v1
   - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è API
   - Backward compatibility

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
   - –û—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –∫–æ–¥–µ
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (Swagger UI —É–∂–µ –µ—Å—Ç—å)
   - –î–∏–∞–≥—Ä–∞–º–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ integration —Ç–µ—Å—Ç–æ–≤
   - E2E —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - Performance —Ç–µ—Å—Ç—ã

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana
   - Distributed tracing (Jaeger/Zipkin)
   - Alerting

4. **CI/CD**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π
   - Canary deployments

### –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–µ—Ç–∫–∏ ref/event-drive –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –æ–±—Ä–∞–∑—Ü–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

‚úÖ **Clean Architecture** - –°—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤  
‚úÖ **DDD** - –ë–æ–≥–∞—Ç—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏  
‚úÖ **Event-Driven** - –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è  
‚úÖ **CQRS** - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤  
‚úÖ **Repository Pattern** - –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏  
‚úÖ **Dependency Injection** - –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π  
‚úÖ **Async/Await** - –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å  
‚úÖ **Resilience Patterns** - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º  
‚úÖ **Observability** - –ú–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏, —Ç—Ä–µ–π—Å–∏–Ω–≥  
‚úÖ **Testability** - –õ–µ–≥–∫–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  

**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –º–æ–∂–µ—Ç —Å–ª—É–∂–∏—Ç—å —ç—Ç–∞–ª–æ–Ω–æ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.

---

**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** AI Assistant  
**–î–∞—Ç–∞:** 27 —è–Ω–≤–∞—Ä—è 2026  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
