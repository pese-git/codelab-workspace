# –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É codelab-ai-service

**–î–∞—Ç–∞:** 2 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è](#–∞–Ω–∞–ª–∏–∑-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)
3. [–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
4. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É)
5. [–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏](#–ø–ª–∞–Ω-–º–∏–≥—Ä–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         WebSocket          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   codelab_ide   ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ     gateway      ‚îÇ
‚îÇ   (–∫–ª–∏–µ–Ω—Ç)      ‚îÇ                             ‚îÇ   (–ø—Ä–æ–∫—Å–∏-—Å–ª–æ–π)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                         ‚îÇ
                                                         ‚îÇ HTTP/SSE
                                                         ‚ñº
                                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                ‚îÇ  agent-runtime   ‚îÇ
                                                ‚îÇ  (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) ‚îÇ
                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Gateway Service
- **–†–æ–ª—å:** –ü—Ä–æ–∫—Å–∏-—Å–ª–æ–π –º–µ–∂–¥—É IDE –∏ agent-runtime
- **–ü—Ä–æ—Ç–æ–∫–æ–ª —Å IDE:** WebSocket (–¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)
- **–ü—Ä–æ—Ç–æ–∫–æ–ª —Å agent-runtime:** HTTP + SSE streaming
- **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:**
  - `gateway/app/main.py` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
  - `gateway/app/api/v1/endpoints.py` - –≤—Å–µ endpoints (658 —Å—Ç—Ä–æ–∫!)
  - `gateway/app/models/websocket.py` - –º–æ–¥–µ–ª–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
  - `gateway/app/services/session_manager.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WS-—Å–µ—Å—Å–∏—è–º–∏
  - `gateway/app/services/token_buffer_manager.py` - –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

#### Agent Runtime Service
- **–†–æ–ª—å:** –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ AI-–∞–≥–µ–Ω—Ç–æ–≤
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Clean Architecture + DDD + Event-Driven
- **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
  - Domain Layer (entities, services, repositories)
  - Application Layer (commands, queries, coordinators)
  - Infrastructure Layer (persistence, events)
  - API Layer (routers, schemas)

---

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### –ü—Ä–æ—Ç–æ–∫–æ–ª Gateway ‚Üî IDE (WebSocket)

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç IDE –∫ Gateway:**
- `user_message` - —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `tool_result` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- `switch_agent` - –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
- `hitl_decision` - —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ HITL
- `plan_decision` - —Ä–µ—à–µ–Ω–∏–µ –ø–æ –æ–¥–æ–±—Ä–µ–Ω–∏—é –ø–ª–∞–Ω–∞

**–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Gateway –∫ IDE:**
- `assistant_message` - –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (streaming)
- `tool_call` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- `agent_switched` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞
- `plan_approval_required` - –∑–∞–ø—Ä–æ—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–ª–∞–Ω–∞
- `error` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

### –ü—Ä–æ—Ç–æ–∫–æ–ª Gateway ‚Üî Agent Runtime (HTTP/SSE)

**REST Endpoints (–ø—Ä–æ–∫—Å–∏):**
- `GET /agents` - —Å–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤
- `GET /agents/{session_id}/current` - —Ç–µ–∫—É—â–∏–π –∞–≥–µ–Ω—Ç
- `GET /sessions` - —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
- `POST /sessions` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `GET /sessions/{session_id}/history` - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `GET /sessions/{session_id}/pending-approvals` - –æ–∂–∏–¥–∞—é—â–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è
- `GET /events/metrics/*` - –º–µ—Ç—Ä–∏–∫–∏
- `GET /events/audit-log` - –∞—É–¥–∏—Ç-–ª–æ–≥

**Streaming Endpoint:**
- `POST /agent/message/stream` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ SSE

---

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ú–∞—Å—Å–∏–≤–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ Gateway endpoints

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ñ–∞–π–ª–µ `gateway/app/api/v1/endpoints.py` (658 —Å—Ç—Ä–æ–∫) —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è 10+ proxy endpoints —Å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

**–ü—Ä–∏–º–µ—Ä –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º endpoint:
async with httpx.AsyncClient(timeout=30.0) as client:
    try:
        response = await client.get(
            f"{AppConfig.AGENT_URL}/...",
            headers={"X-Internal-Auth": AppConfig.INTERNAL_API_KEY},
        )
        response.raise_for_status()
        return response.json()
    except httpx.HTTPStatusError as e:
        logger.error(f"Agent Runtime error: {e.response.status_code}, {e.response.text}")
        return JSONResponse(
            status_code=e.response.status_code,
            content={"error": f"Agent Runtime error: {e.response.status_code}"}
        )
    except Exception as e:
        logger.error(f"Error proxying to Agent Runtime: {e}", exc_info=True)
        return JSONResponse(
            status_code=500,
            content={"error": f"Gateway error: {str(e)}"}
        )
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:** ~10 —Ä–∞–∑ (—Å—Ç—Ä–æ–∫–∏ 38-63, 66-92, 95-121, 124-150, 153-182, 185-230, 233-282, 285-317, 320-359, 362-412)

**–í–ª–∏—è–Ω–∏–µ:**
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –≤ 10 –º–µ—Å—Ç–∞—Ö)
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ù–∞—Ä—É—à–µ–Ω–∏–µ DRY –ø—Ä–∏–Ω—Ü–∏–ø–∞

---

#### 2. –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π WebSocket handler

**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket endpoint –≤ `gateway/app/api/v1/endpoints.py` (—Å—Ç—Ä–æ–∫–∏ 452-658) —Å–æ–¥–µ—Ä–∂–∏—Ç 206 —Å—Ç—Ä–æ–∫ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è:**
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –ü–∞—Ä—Å–∏—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç 5 —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
3. –ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –≤ agent-runtime —á–µ—Ä–µ–∑ HTTP streaming
4. –ü–∞—Ä—Å–∏—Ç SSE stream
5. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
6. –£–ø—Ä–∞–≤–ª—è–µ—Ç lifecycle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ Single Responsibility Principle
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –¢—Ä—É–¥–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ concerns (–ø–∞—Ä—Å–∏–Ω–≥, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)

---

#### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è HTTP-–∫–ª–∏–µ–Ω—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `httpx.AsyncClient` –≤ –∫–∞–∂–¥–æ–º endpoint –±–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ª–µ–≥–∫–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å HTTP-–∫–ª–∏–µ–Ω—Ç
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è middleware (retry, circuit breaker, rate limiting)
- –ó–∞—Ç—Ä—É–¥–Ω–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ –º–æ–∫–∞—Ç—å httpx –Ω–∞–ø—Ä—è–º—É—é)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (timeout, headers)

---

### üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 4. –°–ª–∞–±–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤ WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –í WebSocket handler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `message_data.get("type")` –±–µ–∑ —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏.

**–ö–æ–¥:**
```python
ide_msg = json.loads(raw_msg)
msg_type = ide_msg.get("type")

if msg_type == "user_message":
    msg = WSUserMessage.model_validate(ide_msg)
elif msg_type == "tool_result":
    msg = WSToolResult.model_validate(ide_msg)
# ... –µ—â–µ 3 —Ç–∏–ø–∞
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–∏–ø–∞
- –ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –°–ª–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç type safety –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞

---

#### 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π endpoint –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø–æ-—Å–≤–æ–µ–º—É, –Ω–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.

**–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–∑–ª–∏—á–∏–π:**
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `JSONResponse` —Å –æ—à–∏–±–∫–æ–π
- WebSocket handler –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `WSErrorResponse`
- –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –†–∞–∑–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –æ—à–∏–±–æ–∫

---

#### 6. –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö agent-runtime

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `agent-runtime/app/api/v1/routers/messages_router.py` (310 —Å—Ç—Ä–æ–∫) —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –º–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–π—Å—è –ª–æ–≥–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
async def generate():
    try:
        async for chunk in service.process_xxx(...):
            yield f"data: {chunk.model_dump_json()}\n\n"
    except Exception as e:
        logger.error(f"Error processing xxx: {e}", exc_info=True)
        error_chunk = StreamChunk(type="error", error=str(e), is_final=True)
        yield f"data: {error_chunk.model_dump_json()}\n\n"

return StreamingResponse(
    generate(),
    media_type="text/event-stream",
    headers={
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "X-Accel-Buffering": "no"
    }
)
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:** 5 —Ä–∞–∑ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è)

---

### üü¢ –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 7. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** `AppConfig` –≤ gateway –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å–∞ –≤–º–µ—Å—Ç–æ instance variables.

```python
class AppConfig:
    AGENT_URL: str = os.getenv("GATEWAY__AGENT_URL", "http://localhost:8001")
    INTERNAL_API_KEY: str = os.getenv("GATEWAY__INTERNAL_API_KEY", "change-me-internal-key")
    # ...
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –°–ª–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

---

#### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ observability –≤ Gateway

**–ü—Ä–æ–±–ª–µ–º–∞:** Gateway –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –í—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- –†–∞–∑–º–µ—Ä–µ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Gateway (–Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª)

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.1: –°–æ–∑–¥–∞—Ç—å HTTP Proxy Service

**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ proxy endpoints.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# gateway/app/services/agent_runtime_proxy.py

from typing import Optional, Dict, Any
import httpx
from fastapi.responses import JSONResponse

class AgentRuntimeProxy:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Agent Runtime."""
    
    def __init__(
        self,
        base_url: str,
        internal_api_key: str,
        timeout: float = 30.0
    ):
        self._base_url = base_url
        self._internal_api_key = internal_api_key
        self._timeout = timeout
    
    async def get(
        self,
        path: str,
        params: Optional[Dict[str, Any]] = None
    ) -> JSONResponse:
        """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å GET –∑–∞–ø—Ä–æ—Å."""
        async with httpx.AsyncClient(timeout=self._timeout) as client:
            try:
                response = await client.get(
                    f"{self._base_url}{path}",
                    params=params,
                    headers={"X-Internal-Auth": self._internal_api_key},
                )
                response.raise_for_status()
                return response.json()
            except httpx.HTTPStatusError as e:
                return self._handle_http_error(e)
            except Exception as e:
                return self._handle_generic_error(e)
    
    async def post(
        self,
        path: str,
        json: Optional[Dict[str, Any]] = None
    ) -> JSONResponse:
        """–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å POST –∑–∞–ø—Ä–æ—Å."""
        async with httpx.AsyncClient(timeout=self._timeout) as client:
            try:
                response = await client.post(
                    f"{self._base_url}{path}",
                    json=json,
                    headers={"X-Internal-Auth": self._internal_api_key},
                )
                response.raise_for_status()
                return response.json()
            except httpx.HTTPStatusError as e:
                return self._handle_http_error(e)
            except Exception as e:
                return self._handle_generic_error(e)
    
    def _handle_http_error(self, e: httpx.HTTPStatusError) -> JSONResponse:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å HTTP –æ—à–∏–±–∫—É –æ—Ç Agent Runtime."""
        logger.error(
            f"Agent Runtime error: {e.response.status_code}, "
            f"{e.response.text}"
        )
        return JSONResponse(
            status_code=e.response.status_code,
            content={
                "error": f"Agent Runtime error: {e.response.status_code}"
            }
        )
    
    def _handle_generic_error(self, e: Exception) -> JSONResponse:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±—â—É—é –æ—à–∏–±–∫—É."""
        logger.error(f"Error proxying to Agent Runtime: {e}", exc_info=True)
        return JSONResponse(
            status_code=500,
            content={"error": f"Gateway error: {str(e)}"}
        )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# gateway/app/api/v1/endpoints.py

@router.get("/agents")
async def list_agents(proxy: AgentRuntimeProxy = Depends(get_proxy)):
    return await proxy.get("/agents")

@router.get("/sessions")
async def list_sessions(proxy: AgentRuntimeProxy = Depends(get_proxy)):
    return await proxy.get("/sessions")

@router.post("/sessions")
async def create_session(proxy: AgentRuntimeProxy = Depends(get_proxy)):
    return await proxy.post("/sessions")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å retry, circuit breaker
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ WebSocket Handler

**–¶–µ–ª—å:** –†–∞–∑–¥–µ–ª–∏—Ç—å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π handler –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# gateway/app/services/websocket/message_parser.py

from typing import Union
from pydantic import ValidationError
from app.models.websocket import (
    WSUserMessage, WSToolResult, WSSwitchAgent,
    WSHITLDecision, WSPlanDecision
)

WSMessage = Union[
    WSUserMessage,
    WSToolResult,
    WSSwitchAgent,
    WSHITLDecision,
    WSPlanDecision
]

class WebSocketMessageParser:
    """–ü–∞—Ä—Å–µ—Ä WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."""
    
    def parse(self, raw_message: str) -> WSMessage:
        """
        –ü–∞—Ä—Å–∏—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ.
        
        Raises:
            ValueError: –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        """
        try:
            data = json.loads(raw_message)
            msg_type = data.get("type")
            
            if msg_type == "user_message":
                return WSUserMessage.model_validate(data)
            elif msg_type == "tool_result":
                return WSToolResult.model_validate(data)
            elif msg_type == "switch_agent":
                return WSSwitchAgent.model_validate(data)
            elif msg_type == "hitl_decision":
                return WSHITLDecision.model_validate(data)
            elif msg_type == "plan_decision":
                return WSPlanDecision.model_validate(data)
            else:
                raise ValueError(f"Unknown message type: {msg_type}")
        except json.JSONDecodeError as e:
            raise ValueError(f"Invalid JSON: {e}")
        except ValidationError as e:
            raise ValueError(f"Validation error: {e}")


# gateway/app/services/websocket/sse_stream_handler.py

class SSEStreamHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ SSE stream –æ—Ç Agent Runtime."""
    
    async def process_stream(
        self,
        response: httpx.Response,
        websocket: WebSocket
    ) -> None:
        """
        –ß–∏—Ç–∞–µ—Ç SSE stream –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ WebSocket.
        """
        current_event_type = None
        
        async for line in response.aiter_lines():
            if not line:
                current_event_type = None
                continue
            
            if line.startswith("event: "):
                current_event_type = line[7:].strip()
                if current_event_type == "done":
                    break
                continue
            
            if line.startswith("data: "):
                data_str = line[6:]
                if data_str == "[DONE]":
                    break
                
                if current_event_type == "message":
                    await self._forward_message(data_str, websocket)
                continue
            
            if line.startswith(":"):
                # Heartbeat, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                continue
    
    async def _forward_message(
        self,
        data_str: str,
        websocket: WebSocket
    ) -> None:
        """–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WebSocket."""
        try:
            data = json.loads(data_str)
            # –§–∏–ª—å—Ç—Ä—É–µ–º null –∑–Ω–∞—á–µ–Ω–∏—è
            filtered_data = {k: v for k, v in data.items() if v is not None}
            await websocket.send_json(filtered_data)
        except json.JSONDecodeError as e:
            logger.warning(f"Failed to parse SSE data: {e}")


# gateway/app/services/websocket/websocket_handler.py

class WebSocketHandler:
    """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π."""
    
    def __init__(
        self,
        message_parser: WebSocketMessageParser,
        sse_handler: SSEStreamHandler,
        agent_runtime_url: str,
        internal_api_key: str
    ):
        self._parser = message_parser
        self._sse_handler = sse_handler
        self._agent_runtime_url = agent_runtime_url
        self._internal_api_key = internal_api_key
    
    async def handle_connection(
        self,
        websocket: WebSocket,
        session_id: str
    ) -> None:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."""
        await websocket.accept()
        logger.info(f"[{session_id}] WebSocket connected")
        
        try:
            async with httpx.AsyncClient(timeout=60.0) as client:
                while True:
                    # –ü–æ–ª—É—á–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    raw_msg = await websocket.receive_text()
                    
                    try:
                        message = self._parser.parse(raw_msg)
                    except ValueError as e:
                        await self._send_error(websocket, str(e))
                        continue
                    
                    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –≤ Agent Runtime
                    await self._forward_to_agent(
                        client,
                        websocket,
                        session_id,
                        message
                    )
        except WebSocketDisconnect:
            logger.info(f"[{session_id}] WebSocket disconnected")
        except Exception as e:
            logger.error(f"[{session_id}] WS fatal error: {e}", exc_info=True)
    
    async def _forward_to_agent(
        self,
        client: httpx.AsyncClient,
        websocket: WebSocket,
        session_id: str,
        message: WSMessage
    ) -> None:
        """–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Agent Runtime —á–µ—Ä–µ–∑ HTTP streaming."""
        try:
            async with client.stream(
                "POST",
                f"{self._agent_runtime_url}/agent/message/stream",
                json={
                    "session_id": session_id,
                    "message": message.model_dump()
                },
                headers={"X-Internal-Auth": self._internal_api_key},
            ) as response:
                response.raise_for_status()
                await self._sse_handler.process_stream(response, websocket)
        except httpx.HTTPStatusError as e:
            error_msg = f"Agent error: {e.response.status_code}"
            await self._send_error(websocket, error_msg)
        except Exception as e:
            error_msg = f"Streaming error: {str(e)}"
            await self._send_error(websocket, error_msg)
    
    async def _send_error(self, websocket: WebSocket, message: str) -> None:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ WebSocket."""
        error = WSErrorResponse(type="error", content=message)
        await websocket.send_json(error.model_dump())
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# gateway/app/api/v1/endpoints.py

@router.websocket("/ws/{session_id}")
async def websocket_endpoint(
    websocket: WebSocket,
    session_id: str,
    handler: WebSocketHandler = Depends(get_websocket_handler)
):
    """WebSocket endpoint –¥–ª—è —Å–≤—è–∑–∏ —Å IDE."""
    await handler.handle_connection(websocket, session_id)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (SRP)
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.3: –£–ª—É—á—à–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ–ª–µ–µ –≥–∏–±–∫–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# gateway/app/core/config.py

from pydantic_settings import BaseSettings
from pydantic import Field, validator

class AppConfig(BaseSettings):
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Gateway —Å–µ—Ä–≤–∏—Å–∞."""
    
    # Agent Runtime
    agent_url: str = Field(
        default="http://localhost:8001",
        description="URL Agent Runtime —Å–µ—Ä–≤–∏—Å–∞"
    )
    internal_api_key: str = Field(
        default="change-me-internal-key",
        description="–ö–ª—é—á –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
    )
    
    # Timeouts
    request_timeout: float = Field(
        default=30.0,
        ge=1.0,
        le=300.0,
        description="–¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–µ–∫)"
    )
    agent_stream_timeout: float = Field(
        default=60.0,
        ge=1.0,
        le=600.0,
        description="–¢–∞–π–º–∞—É—Ç –¥–ª—è streaming –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–µ–∫)"
    )
    
    # Logging
    log_level: str = Field(
        default="INFO",
        description="–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"
    )
    
    # Auth
    use_jwt_auth: bool = Field(
        default=False,
        description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é"
    )
    jwt_issuer: str = Field(
        default="https://auth.codelab.local",
        description="JWT issuer"
    )
    jwt_audience: str = Field(
        default="codelab-api",
        description="JWT audience"
    )
    auth_service_url: str = Field(
        default="http://auth-service:8003",
        description="URL Auth —Å–µ—Ä–≤–∏—Å–∞"
    )
    
    # Version
    version: str = Field(
        default="0.1.0",
        description="–í–µ—Ä—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞"
    )
    
    @property
    def jwks_url(self) -> str:
        """URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWKS."""
        return f"{self.auth_service_url}/.well-known/jwks.json"
    
    @validator("log_level")
    def validate_log_level(cls, v):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è."""
        valid_levels = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v.upper() not in valid_levels:
            raise ValueError(f"Invalid log level: {v}")
        return v.upper()
    
    class Config:
        env_prefix = "GATEWAY__"
        case_sensitive = False
        env_file = ".env"
        env_file_encoding = "utf-8"


# –°–æ–∑–¥–∞–µ–º singleton instance
config = AppConfig()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ –õ–µ–≥–∫–æ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- ‚úÖ –ê–≤—Ç–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Field descriptions
- ‚úÖ Type safety
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Agent Runtime (–Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª)

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2.1: –°–æ–∑–¥–∞—Ç—å SSE Response Builder

**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ messages_router.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# agent-runtime/app/api/v1/utils/sse_response.py

from typing import AsyncGenerator, Callable, Awaitable
from fastapi.responses import StreamingResponse
from ....models.schemas import StreamChunk
import logging

logger = logging.getLogger("agent-runtime.api.sse")

class SSEResponseBuilder:
    """–ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å SSE streaming –æ—Ç–≤–µ—Ç–æ–≤."""
    
    @staticmethod
    def create_stream_response(
        generator: AsyncGenerator[StreamChunk, None],
        operation_name: str
    ) -> StreamingResponse:
        """
        –°–æ–∑–¥–∞–µ—Ç SSE streaming response —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
        
        Args:
            generator: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä chunks –æ—Ç —Å–µ—Ä–≤–∏—Å–∞
            operation_name: –ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            
        Returns:
            StreamingResponse —Å SSE —Ñ–æ—Ä–º–∞—Ç–æ–º
        """
        async def generate():
            try:
                async for chunk in generator:
                    # –õ–æ–≥–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    if chunk.type == "plan_approval_required":
                        logger.info(
                            f"[SSE] Sending {chunk.type} chunk for {operation_name}"
                        )
                    
                    yield f"data: {chunk.model_dump_json(exclude_none=False)}\n\n"
                    
            except Exception as e:
                logger.error(
                    f"Error in {operation_name}: {e}",
                    exc_info=True
                )
                error_chunk = StreamChunk(
                    type="error",
                    error=str(e),
                    is_final=True
                )
                yield f"data: {error_chunk.model_dump_json()}\n\n"
        
        return StreamingResponse(
            generate(),
            media_type="text/event-stream",
            headers={
                "Cache-Control": "no-cache",
                "Connection": "keep-alive",
                "X-Accel-Buffering": "no"
            }
        )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# agent-runtime/app/api/v1/routers/messages_router.py

@router.post("/stream")
async def message_stream_sse(
    request: MessageStreamRequest,
    message_orchestration_service=Depends(get_message_orchestration_service)
):
    session_id = request.session_id
    message_data = request.message
    message_type = message_data.get("type")
    
    if message_type == "user_message":
        content = message_data.get("content", "")
        agent_type_str = message_data.get("agent_type")
        agent_type = AgentType(agent_type_str) if agent_type_str else None
        
        generator = message_orchestration_service.process_message(
            session_id=session_id,
            message=content,
            agent_type=agent_type
        )
        
        return SSEResponseBuilder.create_stream_response(
            generator,
            operation_name=f"user_message[{session_id}]"
        )
    
    elif message_type == "tool_result":
        call_id = message_data.get("call_id")
        result = message_data.get("result")
        error = message_data.get("error")
        
        if not call_id:
            raise HTTPException(400, "call_id is required")
        
        generator = message_orchestration_service.process_tool_result(
            session_id=session_id,
            call_id=call_id,
            result=result,
            error=error
        )
        
        return SSEResponseBuilder.create_stream_response(
            generator,
            operation_name=f"tool_result[{session_id}:{call_id}]"
        )
    
    # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~100 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- ‚úÖ –ï–¥–∏–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ SSE
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2.2: –°–æ–∑–¥–∞—Ç—å Message Handler Registry

**–¶–µ–ª—å:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# agent-runtime/app/api/v1/handlers/message_handler.py

from abc import ABC, abstractmethod
from typing import AsyncGenerator, Dict, Any
from ....models.schemas import StreamChunk

class MessageHandler(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    
    @abstractmethod
    async def handle(
        self,
        session_id: str,
        message_data: Dict[str, Any],
        orchestration_service
    ) -> AsyncGenerator[StreamChunk, None]:
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ."""
        pass
    
    @abstractmethod
    def validate(self, message_data: Dict[str, Any]) -> None:
        """–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è."""
        pass


# agent-runtime/app/api/v1/handlers/user_message_handler.py

class UserMessageHandler(MessageHandler):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ user_message."""
    
    def validate(self, message_data: Dict[str, Any]) -> None:
        if "content" not in message_data:
            raise ValueError("content is required")
    
    async def handle(
        self,
        session_id: str,
        message_data: Dict[str, Any],
        orchestration_service
    ) -> AsyncGenerator[StreamChunk, None]:
        content = message_data.get("content", "")
        agent_type_str = message_data.get("agent_type")
        agent_type = AgentType(agent_type_str) if agent_type_str else None
        
        async for chunk in orchestration_service.process_message(
            session_id=session_id,
            message=content,
            agent_type=agent_type
        ):
            yield chunk


# agent-runtime/app/api/v1/handlers/registry.py

class MessageHandlerRegistry:
    """–†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    
    def __init__(self):
        self._handlers: Dict[str, MessageHandler] = {}
    
    def register(self, message_type: str, handler: MessageHandler) -> None:
        """–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫."""
        self._handlers[message_type] = handler
    
    def get_handler(self, message_type: str) -> MessageHandler:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ —Ç–∏–ø—É —Å–æ–æ–±—â–µ–Ω–∏—è."""
        handler = self._handlers.get(message_type)
        if not handler:
            raise ValueError(f"Unknown message type: {message_type}")
        return handler


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–µ—Å—Ç—Ä–∞
registry = MessageHandlerRegistry()
registry.register("user_message", UserMessageHandler())
registry.register("tool_result", ToolResultHandler())
registry.register("switch_agent", SwitchAgentHandler())
registry.register("hitl_decision", HITLDecisionHandler())
registry.register("plan_decision", PlanDecisionHandler())
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# agent-runtime/app/api/v1/routers/messages_router.py

@router.post("/stream")
async def message_stream_sse(
    request: MessageStreamRequest,
    message_orchestration_service=Depends(get_message_orchestration_service),
    handler_registry: MessageHandlerRegistry = Depends(get_handler_registry)
):
    session_id = request.session_id
    message_data = request.message
    message_type = message_data.get("type")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞
        handler = handler_registry.get_handler(message_type)
        
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        handler.validate(message_data)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        generator = handler.handle(
            session_id,
            message_data,
            message_orchestration_service
        )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º SSE response
        return SSEResponseBuilder.create_stream_response(
            generator,
            operation_name=f"{message_type}[{session_id}]"
        )
        
    except ValueError as e:
        raise HTTPException(400, str(e))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ö–æ–¥ —Ä–æ—É—Ç–µ—Ä–∞ —Å–æ–∫—Ä–∞—Ç–∏–ª—Å—è —Å 310 –¥–æ ~50 —Å—Ç—Ä–æ–∫
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3.1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Gateway

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å observability.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# gateway/app/services/metrics.py

from prometheus_client import Counter, Histogram, Gauge
import time

# –ú–µ—Ç—Ä–∏–∫–∏ WebSocket
ws_connections_total = Counter(
    "gateway_ws_connections_total",
    "Total WebSocket connections",
    ["session_id"]
)

ws_active_connections = Gauge(
    "gateway_ws_active_connections",
    "Active WebSocket connections"
)

ws_messages_received = Counter(
    "gateway_ws_messages_received_total",
    "Total messages received from IDE",
    ["message_type"]
)

ws_messages_sent = Counter(
    "gateway_ws_messages_sent_total",
    "Total messages sent to IDE",
    ["message_type"]
)

# –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
proxy_requests_total = Counter(
    "gateway_proxy_requests_total",
    "Total proxy requests to Agent Runtime",
    ["endpoint", "method", "status"]
)

proxy_request_duration = Histogram(
    "gateway_proxy_request_duration_seconds",
    "Proxy request duration",
    ["endpoint", "method"]
)

# –ú–µ—Ç—Ä–∏–∫–∏ –æ—à–∏–±–æ–∫
proxy_errors_total = Counter(
    "gateway_proxy_errors_total",
    "Total proxy errors",
    ["endpoint", "error_type"]
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Visibility –≤ production
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3.2: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–¶–µ–ª—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# gateway/tests/test_websocket_protocol.py

import pytest
from fastapi.testclient import TestClient

@pytest.mark.asyncio
async def test_user_message_flow():
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow user_message."""
    with TestClient(app) as client:
        with client.websocket_connect("/ws/test-session") as websocket:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º user_message
            websocket.send_json({
                "type": "user_message",
                "content": "Hello",
                "role": "user"
            })
            
            # –û–∂–∏–¥–∞–µ–º assistant_message
            response = websocket.receive_json()
            assert response["type"] == "assistant_message"
            assert "token" in response


@pytest.mark.asyncio
async def test_tool_call_flow():
    """–¢–µ—Å—Ç flow —Å tool_call."""
    with TestClient(app) as client:
        with client.websocket_connect("/ws/test-session") as websocket:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            websocket.send_json({
                "type": "user_message",
                "content": "Read file test.py",
                "role": "user"
            })
            
            # –û–∂–∏–¥–∞–µ–º tool_call
            response = websocket.receive_json()
            assert response["type"] == "tool_call"
            call_id = response["call_id"]
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º tool_result
            websocket.send_json({
                "type": "tool_result",
                "call_id": call_id,
                "result": {"content": "file content"}
            })
            
            # –û–∂–∏–¥–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
            response = websocket.receive_json()
            assert response["type"] == "assistant_message"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã
- ‚úÖ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
- ‚úÖ **–ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –Ω–∞—Ä—É—à–µ–Ω**

---

## –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: Gateway Refactoring (1-2 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 1:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `AgentRuntimeProxy` —Å–µ—Ä–≤–∏—Å
2. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –≤—Å–µ proxy endpoints
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è proxy
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ Pydantic Settings

**–ù–µ–¥–µ–ª—è 2:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `WebSocketMessageParser`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `SSEStreamHandler`
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å `WebSocketHandler`
4. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å WebSocket endpoint
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç >80% –∫–æ–¥–∞
- –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ö–æ–¥ gateway —Å–æ–∫—Ä–∞—â–µ–Ω –Ω–∞ ~300 —Å—Ç—Ä–æ–∫

---

### –§–∞–∑–∞ 2: Agent Runtime Refactoring (1 –Ω–µ–¥–µ–ª—è)

**–ù–µ–¥–µ–ª—è 3:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `SSEResponseBuilder`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `MessageHandler` –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å `MessageHandlerRegistry`
4. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å handlers –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
5. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å `messages_router`
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ö–æ–¥ messages_router —Å–æ–∫—Ä–∞—â–µ–Ω —Å 310 –¥–æ ~50 —Å—Ç—Ä–æ–∫
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

### –§–∞–∑–∞ 3: Observability (1 –Ω–µ–¥–µ–ª—è)

**–ù–µ–¥–µ–ª—è 4:**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ –≤ Gateway
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ –≤ Agent Runtime
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana –¥–∞—à–±–æ—Ä–¥—ã
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å health checks
5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –î–∞—à–±–æ—Ä–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **–ü—Ä–æ—Ç–æ–∫–æ–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω** –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. **–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. **–í—Å–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∏** –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
4. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ agent-runtime** —Å–ª–µ–¥—É–µ—Ç Clean Architecture, –Ω–æ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ API

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å):**
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Gateway proxy endpoints (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.1)
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ WebSocket handler (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.2)
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ messages_router (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2.1)

**–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
- ‚ö†Ô∏è Message Handler Registry (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2.2)
- ‚ö†Ô∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1.3)

**–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
- üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ observability (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3.1)
- üß™ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3.2)

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞:** ~500 —Å—Ç—Ä–æ–∫
- **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏:** –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ
- **–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:** ‚ùå –ù–ï–¢
- **Breaking changes:** ‚ùå –ù–ï–¢

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–ê–≤—Ç–æ—Ä:** AI Code Analyzer  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
