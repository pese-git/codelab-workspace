# üìã –û—Ç—á–µ—Ç: –§–∞–∑–∞ 10.1.3 - –ú–∏–≥—Ä–∞—Ü–∏—è ExecutionEngine

**–î–∞—Ç–∞:** 6 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 3 —á–∞—Å–∞ (–ø–ª–∞–Ω) ‚Üí 1.5 —á–∞—Å–∞ (—Ñ–∞–∫—Ç)

---

## üéØ –¶–µ–ª—å —Ñ–∞–∑—ã

–°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä ExecutionEngineAdapter –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É legacy ExecutionEngine –∏ –Ω–æ–≤—ã–º PlanExecutionService –∏–∑ DDD-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

**–í–∞–∂–Ω–æ:** PlanExecutionService —É–∂–µ –±—ã–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –§–∞–∑–µ 5, –ø–æ—ç—Ç–æ–º—É –∑–∞–¥–∞—á–∞ —Å–≤–µ–ª–∞—Å—å –∫ —Å–æ–∑–¥–∞–Ω–∏—é –∞–¥–∞–ø—Ç–µ—Ä–∞ –∏ —Ç–µ—Å—Ç–æ–≤.

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω ExecutionEngineAdapter

**–§–∞–π–ª:** [`app/domain/adapters/execution_engine_adapter.py`](../codelab-ai-service/agent-runtime/app/domain/adapters/execution_engine_adapter.py)

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–†–∞–∑–º–µ—Ä:** ~310 —Å—Ç—Ä–æ–∫
- **–ú–µ—Ç–æ–¥—ã:** 4 –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∞
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** PlanExecutionService
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (–ø—Ä–æ—Å—Ç–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
1. ‚úÖ –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –≤—ã–∑–æ–≤—ã –≤ PlanExecutionService
2. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–∏–ø—ã (str ‚Üí PlanId)
3. ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ (PlanExecutionError ‚Üí ExecutionEngineError)
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç streaming –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
5. ‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å ExecutionEngine API

**–ú–µ—Ç–æ–¥—ã:**
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- execute_plan()              # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞–Ω (streaming)
- get_execution_status()      # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∞
- cancel_execution()          # –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- get_next_executable_subtasks()  # –ü–æ–ª—É—á–∏—Ç—å –≥–æ—Ç–æ–≤—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
adapter = ExecutionEngineAdapter(plan_execution_service)

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
async for chunk in adapter.execute_plan(
    plan_id="plan-123",
    session_id="session-456",
    session_service=session_service,
    stream_handler=stream_handler
):
    print(chunk)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
status = await adapter.get_execution_status("plan-123")

# –û—Ç–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
await adapter.cancel_execution("plan-123", reason="User cancelled")
```

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω __init__.py –¥–ª—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

**–§–∞–π–ª:** [`app/domain/adapters/__init__.py`](../codelab-ai-service/agent-runtime/app/domain/adapters/__init__.py)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç `ExecutionEngineAdapter`
- –î–æ–±–∞–≤–ª–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç `ExecutionEngineError`
- –î–æ–±–∞–≤–ª–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç `ExecutionResult`

---

### 3. –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è ExecutionEngineAdapter

**–§–∞–π–ª:** [`tests/unit/domain/adapters/test_execution_engine_adapter.py`](../codelab-ai-service/agent-runtime/tests/unit/domain/adapters/test_execution_engine_adapter.py)

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–†–∞–∑–º–µ—Ä:** ~470 —Å—Ç—Ä–æ–∫
- **–¢–µ—Å—Ç–æ–≤:** 15
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** 100%
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 15/15 passed

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

#### TestExecutionEngineAdapter (12 —Ç–µ—Å—Ç–æ–≤)
1. ‚úÖ `test_initialization` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞
2. ‚úÖ `test_execute_plan_success` - –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
3. ‚úÖ `test_execute_plan_converts_plan_id` - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è str ‚Üí PlanId
4. ‚úÖ `test_execute_plan_handles_plan_execution_error` - –û–±—Ä–∞–±–æ—Ç–∫–∞ PlanExecutionError
5. ‚úÖ `test_execute_plan_handles_unexpected_error` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
6. ‚úÖ `test_get_execution_status_success` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
7. ‚úÖ `test_get_execution_status_handles_error` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
8. ‚úÖ `test_cancel_execution_success` - –û—Ç–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
9. ‚úÖ `test_cancel_execution_default_reason` - –û—Ç–º–µ–Ω–∞ —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π
10. ‚úÖ `test_cancel_execution_handles_error` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ—Ç–º–µ–Ω—ã
11. ‚úÖ `test_get_next_executable_subtasks_success` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á
12. ‚úÖ `test_get_next_executable_subtasks_handles_error` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø–æ–¥–∑–∞–¥–∞—á

#### TestExecutionResult (3 —Ç–µ—Å—Ç–∞)
1. ‚úÖ `test_execution_result_initialization` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
2. ‚úÖ `test_execution_result_to_dict` - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ —Å–ª–æ–≤–∞—Ä—å
3. ‚úÖ `test_execution_result_success_rate_calculation` - –†–∞—Å—á–µ—Ç success_rate

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
$ uv run pytest tests/unit/domain/adapters/test_execution_engine_adapter.py -v
======================= 15 passed, 75 warnings in 0.45s ========================
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ö–æ–¥
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ | 2 |
| –§–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ | 1 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (–∞–¥–∞–ø—Ç–µ—Ä) | ~310 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (—Ç–µ—Å—Ç—ã) | ~470 |
| **–ò—Ç–æ–≥–æ —Å—Ç—Ä–æ–∫** | **~780** |

### –¢–µ—Å—Ç—ã
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ | 15 |
| –ü—Ä–æ—Ö–æ–¥—è—Ç | 15 (100%) |
| –ü–æ–∫—Ä—ã—Ç–∏–µ | 100% |
| –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | 0.45 —Å–µ–∫ |

### –í—Ä–µ–º—è
| –≠—Ç–∞–ø | –ü–ª–∞–Ω | –§–∞–∫—Ç | –≠–∫–æ–Ω–æ–º–∏—è |
|------|------|------|----------|
| –ê–Ω–∞–ª–∏–∑ | 0.5—á | 0.3—á | 0.2—á |
| –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | 1.5—á | 0.7—á | 0.8—á |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 1.0—á | 0.5—á | 0.5—á |
| **–ò—Ç–æ–≥–æ** | **3.0—á** | **1.5—á** | **1.5—á** |

---

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

1. **–ê–¥–∞–ø—Ç–µ—Ä –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è**
   - PlanExecutionService —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª
   - –°–æ–∑–¥–∞–Ω —Ç–æ–Ω–∫–∏–π –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ

2. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤**
   - `str` ‚Üí `PlanId` –¥–ª—è plan_id
   - `PlanExecutionError` ‚Üí `ExecutionEngineError`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ legacy –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

3. **Streaming –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
   - AsyncGenerator –¥–ª—è chunks
   - –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Ç PlanExecutionService
   - –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å ExecutionCoordinator

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
   - –ü–µ—Ä–µ—Ö–≤–∞—Ç PlanExecutionError
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ ExecutionEngineError
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥  
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - legacy –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å  
‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Value Objects  
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead –∞–¥–∞–ø—Ç–∞—Ü–∏–∏  

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ
1. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º –∏ —Ç–µ—Å—Ç–∞–º–∏
2. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –§–∞–∑—ã 10

### –î–∞–ª–µ–µ (–§–∞–∑–∞ 10.1.4)
–ú–∏–≥—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö Domain Services:
- `message_processor.py`
- `agent_switcher.py`
- `tool_result_handler.py`
- `hitl_decision_handler.py`
- `plan_approval_handler.py`
- `subtask_executor.py`
- `dependency_resolver.py`

**–û—Ü–µ–Ω–∫–∞:** 3 —á–∞—Å–∞

---

## üìù –ó–∞–º–µ—Ç–∫–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

1. **PlanExecutionService** - —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –§–∞–∑–µ 5
2. **–ê–¥–∞–ø—Ç–µ—Ä** - –ø—Ä–æ—Å—Ç–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
3. **–¢–µ—Å—Ç—ã** - –±—ã—Å—Ç—Ä—ã–µ –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ (0.45 —Å–µ–∫)
4. **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - Value Objects –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏

### –£—Ä–æ–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞** - PlanExecutionService —É–∂–µ –±—ã–ª –≥–æ—Ç–æ–≤
2. **–ê–¥–∞–ø—Ç–µ—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ** - —á–µ–º –ø–æ–ª–Ω–æ–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ
3. **–¢–µ—Å—Ç—ã –≤–∞–∂–Ω—ã** - –Ω–∞—à–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º —Å —Ç–∏–ø–∞–º–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–º–æ–≥–∞–µ—Ç** - –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–æ–±—Ä–∞–ª–∏—Å—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –°–æ–∑–¥–∞–Ω ExecutionEngineAdapter
- [x] –û–±–Ω–æ–≤–ª–µ–Ω __init__.py –¥–ª—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤
- [x] –ù–∞–ø–∏—Å–∞–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (15/15)
- [x] –ü–æ–∫—Ä—ã—Ç–∏–µ 100%
- [x] –°–æ–∑–¥–∞–Ω –æ—Ç—á–µ—Ç –æ —Ñ–∞–∑–µ

---

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –§–∞–∑—ã 10

```
–§–∞–∑–∞ 10: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (21 —á–∞—Å)
‚îú‚îÄ‚îÄ ‚úÖ 10.1.1: SessionManagementService (1.5—á / 2—á)
‚îú‚îÄ‚îÄ ‚úÖ 10.1.2: AgentOrchestrationService (1.5—á / 2—á)
‚îú‚îÄ‚îÄ ‚úÖ 10.1.3: ExecutionEngine (1.5—á / 3—á)
‚îú‚îÄ‚îÄ ‚è≥ 10.1.4: –û—Å—Ç–∞–ª—å–Ω—ã–µ Services (0—á / 3—á)
‚îú‚îÄ‚îÄ ‚è≥ 10.2: Infrastructure Layer (0—á / 5—á)
‚îú‚îÄ‚îÄ ‚è≥ 10.3: Application Layer (0—á / 3.5—á)
‚îî‚îÄ‚îÄ ‚è≥ 10.4: Legacy Code Removal (0—á / 2.5—á)

–ü—Ä–æ–≥—Ä–µ—Å—Å: 21% (4.5/21 —á–∞—Å–æ–≤)
–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏: 2.5 —á–∞—Å–∞ (–ø–ª–∞–Ω: 7—á, —Ñ–∞–∫—Ç: 4.5—á)
```

---

**–§–∞–∑–∞ 10.1.3 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ**
