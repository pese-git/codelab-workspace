# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ 401 (Unauthorized). –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

1. **–•—Ä–∞–Ω–µ–Ω–∏–µ refresh_token** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ refresh_token –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ access_token
3. **Retry –ø—Ä–∏ 401** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ª–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –µ—Å–ª–∏ refresh_token –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. AuthManager (`src/auth.py`)

#### –î–æ–±–∞–≤–ª–µ–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh_token

```python
self.access_token: Optional[str] = None
self.refresh_token: Optional[str] = None  # –ù–æ–≤–æ–µ –ø–æ–ª–µ
```

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `refresh_access_token()`

–û–±–Ω–æ–≤–ª—è–µ—Ç access_token –∏—Å–ø–æ–ª—å–∑—É—è refresh_token —á–µ—Ä–µ–∑ OAuth2 grant type `refresh_token`:

```python
async def refresh_access_token(self) -> str:
    """
    Refresh JWT access token using refresh_token.
    
    Returns:
        New access token
        
    Raises:
        ValueError: If refresh_token is not available or refresh fails
    """
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
- –ï—Å–ª–∏ refresh_token –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ï—Å–ª–∏ refresh_token –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üí fallback –Ω–∞ –ø–æ–ª–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `handle_unauthorized()`

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É 401 Unauthorized:

```python
async def handle_unauthorized(self) -> None:
    """
    Handle 401 Unauthorized error by refreshing the token.
    
    This method should be called when a request returns 401.
    """
```

### 2. GatewayClient (`src/client.py`)

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_make_http_request()`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry –ø—Ä–∏ 401:

```python
async def _make_http_request(
    self,
    method: str,
    url: str,
    retry_on_401: bool = True,
    **kwargs
) -> httpx.Response:
    """
    Make HTTP request with automatic token refresh on 401.
    """
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–∫—É—â–∏–º —Ç–æ–∫–µ–Ω–æ–º
2. –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω 401 –∏ `retry_on_401=True`:
   - –í—ã–∑—ã–≤–∞–µ—Ç `auth_manager.handle_unauthorized()`
   - –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
   - –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

#### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã

–í—Å–µ HTTP –º–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `_make_http_request()`:

- `create_session()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry
- `get_session_metrics()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry
- `test_connection()` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
auth_manager = AuthManager(config)
client = GatewayClient(base_url, ws_url, auth_manager)

# –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç 401
session_id = await client.create_session()  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ 401
metrics = await client.get_session_metrics(session_id)  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ 401
```

### –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

```python
auth_manager = AuthManager(config)

# –ü–µ—Ä–≤–∏—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
await auth_manager.authenticate_jwt()

# –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
new_token = await auth_manager.refresh_access_token()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–∫–∏
await auth_manager.handle_unauthorized()
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JWT

```yaml
gateway:
  auth_type: jwt
  jwt:
    auth_url: "http://localhost:8080/api/v1/auth/token"
    username: "user@example.com"
    password: "password"
    client_id: "benchmark-client"
    client_secret: ""  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
cd benchmark-standalone
uv run python test_token_refresh.py
```

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **Internal Auth** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å API –∫–ª—é—á–æ–º
2. **JWT Auth** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤
3. **Token Refresh** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ refresh_token
4. **401 Handling** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```
‚úÖ Internal Auth: PASS
‚úÖ JWT Auth: PASS (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π auth service)
```

## –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

```
1. –ü–µ—Ä–≤–∏—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   ‚Üì
   authenticate_jwt()
   ‚Üì
   –ü–æ–ª—É—á–µ–Ω–∏–µ access_token + refresh_token
   
2. HTTP –∑–∞–ø—Ä–æ—Å
   ‚Üì
   _make_http_request()
   ‚Üì
   –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Authorization header
   ‚Üì
   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
   
3. –ï—Å–ª–∏ 401 Unauthorized
   ‚Üì
   handle_unauthorized()
   ‚Üì
   refresh_access_token()
   ‚Üì
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ refresh_token
   ‚Üì
   –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access_token
   ‚Üì
   –ü–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞ —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
   
4. –ï—Å–ª–∏ refresh_token –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   ‚Üì
   Fallback –Ω–∞ authenticate_jwt()
   ‚Üì
   –ü–æ–ª–Ω–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Internal API Key –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–º –∫–æ–¥–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 401 –¥–ª—è –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:

```
üîê Authenticating with OAuth2: user@example.com
‚úÖ JWT token obtained successfully
üîÑ Refreshing access token using refresh_token...
‚úÖ Access token refreshed successfully
‚ö†Ô∏è Received 401 from http://..., refreshing token and retrying...
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **Refresh token rotation** - –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–µ—Ç –Ω–æ–≤—ã–π refresh_token –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
2. **–û–¥–∏–Ω retry** - —Å–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ø–æ–ø—ã—Ç–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ 401
3. **Thread safety** - AuthManager –Ω–µ —è–≤–ª—è–µ—Ç—Å—è thread-safe, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –ø–æ—Ç–æ–∫
4. **Timeout** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ timeout –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ httpx

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—è expires_in)
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö OAuth2 grant types
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
